<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f7c600">
  <meta name="description" content="Sistema de comisiones offline para vendedores">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Comisiones">
  <title>Sistema de Comisiones</title>
  <link rel="manifest" href="#" id="manifest-placeholder">
  <style>
    :root {
      --bg: #0f0f10;
      --card: #1a1a1c;
      --text: #ffffff;
      --accent: #f7c600;
      --accent-strong: #d1a400;
      --muted: #999999;
      --border: #2a2a2a;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 8px;
      overflow-x: hidden;
    }
    
    .header {
      background: var(--accent);
      padding: 16px 12px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(247, 198, 0, 0.3);
    }
    
    .header h2 {
      margin: 0;
      color: #111111;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
    }
    
    .header p {
      margin: 4px 0 0 0;
      color: #111111;
      font-size: 13px;
      opacity: 0.85;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    
    .totals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .total-cell {
      background: var(--card);
      border-radius: 8px;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .total-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .total-value {
      font-size: 18px;
      color: var(--accent);
      font-weight: 700;
      word-break: break-word;
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      flex: 1;
      background: var(--card);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      padding: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input[type="text"]:focus {
      border-color: var(--accent);
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: scale(0.97);
    }
    
    .btn-accent {
      background: var(--accent);
      color: #111111;
    }
    
    .btn-accent:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .btn-danger {
      background: #dc2626;
      color: #ffffff;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-info {
      background: #3b82f6;
      color: #ffffff;
    }
    
    .btn-info:hover {
      background: #2563eb;
    }
    
    .btn-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    
    .btn-container .btn {
      flex: 1;
      min-width: 140px;
    }
    
    .sales-list {
      background: var(--card);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      height: 200px; /* Altura fija para mostrar 4 registros */
      overflow-y: auto;
      border: 1px solid var(--border);
    }
    
    .sales-list:empty::after {
      content: "(sin ventas)";
      color: var(--muted);
      font-style: italic;
      display: block;
      text-align: center;
      padding: 20px;
    }
    
    .sale-item {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      line-height: 1.6;
      min-height: 40px; /* Altura aproximada para 4 registros visibles */
    }
    
    .sale-item:last-child {
      border-bottom: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      border: 2px solid var(--border);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
    }
    
    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    
    .modal-buttons .btn {
      flex: 1;
    }
    
    .install-prompt {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .install-prompt.show {
      display: flex;
    }
    
    .install-prompt-text {
      flex: 1;
      color: #111111;
      font-size: 14px;
      font-weight: 600;
    }
    
    .install-prompt .btn {
      background: #111111;
      color: var(--accent);
      padding: 8px 16px;
      font-size: 13px;
    }
    
    /* ==================== NUEVOS ESTILOS PARA AN√ÅLISIS ==================== */
    .analysis-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .analysis-screen.active {
      display: block;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .kpi-card {
      background: var(--card);
      border-radius: 8px;
      padding: 16px 12px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .kpi-period {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .kpi-title {
      font-size: 13px;
      color: var(--accent);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .kpi-value {
      font-size: 18px;
      color: var(--text);
      font-weight: 700;
      word-break: break-word;
    }
    
    .hourly-chart-container {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    /* ==================== ESTILOS PARA UPLOAD ==================== */
    .file-upload-container {
      margin: 16px 0;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-button {
      background: var(--accent);
      color: #111111;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: block;
      text-align: center;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .file-input-button:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .file-name {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      word-break: break-all;
    }
    
    .upload-preview {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
    }
    
    .upload-preview table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .upload-preview th {
      text-align: left;
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--accent);
      font-size: 11px;
    }
    
    .upload-preview td {
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    
    /* ==================== FIX PARA INPUT DATE EN M√ìVILES ==================== */
    input[type="date"] {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      width: 100%;
      position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.7;
      cursor: pointer;
      padding: 4px;
      margin-left: 4px;
    }
    
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
    }
    
    /* Estilo alternativo para m√≥viles */
    .date-input-wrapper {
      position: relative;
      width: 100%;
    }
    
    .date-input-wrapper::after {
      content: "üìÖ";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      font-size: 16px;
      pointer-events: none;
    }
    
    select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px 36px 12px 12px;
      font-size: 14px;
      width: 100%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23f7c600' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ==================== NUEVO ORDEN DE ELEMENTOS ==================== */
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 16px 0;
    }
    
    .actions-grid .btn {
      width: 100%;
    }
    
    /* ==================== ESTILOS PARA CRM ==================== */
    .tag {
      display: inline-block;
      padding: 4px 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    
    .tag:hover {
      background: var(--accent);
      color: #111111;
      transform: scale(1.05);
    }
    
    .tag.active {
      background: var(--accent);
      color: #111111;
      font-weight: 600;
    }
    
    .prospect-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .prospect-item:hover {
      background: rgba(247, 198, 0, 0.1);
    }
    
    .prospect-info {
      flex: 1;
    }
    
    .prospect-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .prospect-details {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .prospect-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-not-contacted {
      background: #dc2626;
      color: white;
    }
    
    .status-contacted {
      background: #10b981;
      color: white;
    }
    
    .status-whatsapp {
      background: #25D366;
      color: white;
    }
    
    .status-call {
      background: #3b82f6;
      color: white;
    }
    
    .status-both {
      background: linear-gradient(135deg, #25D366 0%, #3b82f6 100%);
      color: white;
    }
    
    .observation-item {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    
    .observation-date {
      color: var(--accent);
      font-size: 10px;
      margin-bottom: 2px;
    }
    
    .observation-text {
      color: var(--text);
    }
    
    /* ==================== ESTILOS PARA WHATSAPP ==================== */
    .btn-whatsapp {
      background: #25D366;
      color: white;
    }
    
    .btn-whatsapp:hover {
      background: #1da851;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }
    
    .vendedor-config {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    .vendedor-config h3 {
      font-size: 16px;
      color: var(--accent);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .vendedor-config h3::before {
      content: "üë§";
      font-size: 18px;
    }
    
    .vendedor-input-group {
      display: flex;
      gap: 8px;
    }
    
    .vendedor-input-group input {
      flex: 1;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
    }
    
    .vendedor-input-group button {
      background: var(--accent);
      color: #111111;
      border: none;
      border-radius: 8px;
      padding: 0 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vendedor-input-group button:hover {
      background: var(--accent-strong);
    }
    
    .vendedor-current {
      margin-top: 12px;
      padding: 10px;
      background: rgba(247, 198, 0, 0.1);
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    
    .vendedor-current strong {
      color: var(--accent);
    }
    
    /* ==================== BOT√ìN INTERMITENTE MEJORADO ==================== */
    .btn-flashing {
      background: #dc2626;
      color: #ffffff;
      position: relative;
      overflow: hidden;
      animation: flashing 0.7s infinite;
      box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
    }
    
    .btn-flashing:hover {
      background: #b91c1c;
      animation: flashing-fast 0.4s infinite;
    }
    
    @keyframes flashing {
      0% { 
        background-color: #dc2626;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
      }
      50% { 
        background-color: #ff0000;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      }
      100% { 
        background-color: #dc2626;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
      }
    }
    
    @keyframes flashing-fast {
      0% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
      25% { 
        background-color: #ff0000;
        box-shadow: 0 0 25px rgba(255, 0, 0, 1);
      }
      50% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
      75% { 
        background-color: #ff0000;
        box-shadow: 0 0 25px rgba(255, 0, 0, 1);
      }
      100% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
    }
    
    @media (max-width: 768px) {
      .header h2 { font-size: 18px; }
      .total-value { font-size: 16px; }
      .total-label { font-size: 10px; }
      .btn-container { flex-direction: column; }
      .btn-container .btn { min-width: 100%; }
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-value { font-size: 16px; }
      .sales-list { height: 180px; }
      .actions-grid { grid-template-columns: 1fr; }
      .vendedor-input-group { flex-direction: column; }
      .vendedor-input-group button { width: 100%; padding: 12px; }
    }
    
    @media (max-width: 480px) {
      body { padding: 4px; }
      .header h2 { font-size: 16px; }
      .total-value { font-size: 14px; }
      .total-label { font-size: 9px; }
      .totals-grid { gap: 6px; }
      .modal-content {
        padding: 16px;
        max-width: 95%;
      }
      .kpi-value { font-size: 14px; }
      .sales-list { height: 160px; }
    }
  </style>
</head>
<body>
  <!-- Pantalla Principal (siempre visible al inicio) -->
  <div id="mainScreen">
    <div id="installPrompt" class="install-prompt">
      <div class="install-prompt-text">
        üì± Instala esta app en tu celular para usarla offline
      </div>
      <button class="btn" onclick="installApp()">Instalar</button>
    </div>

    <div class="header">
      <h2>Neum√°ticos y Llantas del Pac√≠fico</h2>
      <p>Sistema de Comisiones</p>
    </div>

    <!-- 1. RESUMEN DE VENTAS -->
    <div class="section-title">üìä Resumen de Ventas</div>
    <div class="totals-grid">
      <div class="total-cell">
        <div class="total-label">Total D√≠a (con IVA)</div>
        <div class="total-value" id="dayWithVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total D√≠a (sin IVA)</div>
        <div class="total-value" id="dayWithoutVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Comisi√≥n D√≠a</div>
        <div class="total-value" id="dayCommission">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total Mes (con IVA)</div>
        <div class="total-value" id="monthWithVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total Mes (sin IVA)</div>
        <div class="total-value" id="monthWithoutVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Comisi√≥n Mes</div>
        <div class="total-value" id="monthCommission">$ 0</div>
      </div>
    </div>

    <!-- 2. AGREGAR VENTA -->
    <div class="section-title">‚ûï Agregar Venta</div>
    <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
      Introduce el <strong>monto TOTAL con IVA</strong> (ejemplo: 119000):
    </p>
    <div class="input-group">
      <input type="text" id="amountInput" placeholder="119000" inputmode="numeric">
      <button class="btn btn-accent" onclick="addSale()">Agregar</button>
    </div>
    
    <button class="btn btn-danger" onclick="deleteLastSale()" style="width: 100%; margin-top: 8px; margin-bottom: 24px;">
      üóëÔ∏è Eliminar √öltima Venta
    </button>

    <!-- 3. ACCIONES - REORDENADO EN 3 FILAS Y 2 COLUMNAS (SE ELIMIN√ì LA FILA DE TRABAJOS) -->
    <div class="section-title">‚öôÔ∏è Acciones</div>
    <div class="actions-grid">
      <!-- Fila 1 -->
      <button class="btn btn-danger" onclick="showCloseDayModal()">Cerrar D√≠a</button>
      <button class="btn btn-danger" onclick="showCloseCycleModal()">Cerrar Ciclo</button>
      
      <!-- Fila 2 -->
      <button class="btn btn-accent" onclick="showAnalysisScreen()">An√°lisis de Ventas</button>
      <button class="btn btn-accent" onclick="showModifyModal()">Modificar Ventas</button>
      
      <!-- Fila 3 -->
      <button class="btn btn-info" onclick="showCRMScreen()">Gesti√≥n de Clientes</button>
      <button class="btn btn-secondary" onclick="showExportModal()">Exportar Ventas</button>
      
      <!-- Fila 4 -->
      <button class="btn btn-info" onclick="showUploadModal()">Subir Archivos Ventas</button>
    </div>

    <!-- 4. GR√ÅFICOS -->
    <div class="section-title">üìä Gr√°ficos</div>
    <div style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
      <h3 style="font-size: 14px; color: var(--accent); margin-bottom: 12px; font-weight: 600;">Comisiones Diarias (Mes Actual)</h3>
      <canvas id="dailyChart" style="max-height: 250px;"></canvas>
    </div>
    
    <div style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
      <h3 style="font-size: 14px; color: var(--accent); margin-bottom: 12px; font-weight: 600;">Comisiones Mensuales (Hist√≥rico)</h3>
      <canvas id="monthlyChart" style="max-height: 250px;"></canvas>
    </div>

    <!-- 5. VENTAS DEL D√çA (4 registros visibles) -->
    <div class="section-title">üìÖ Ventas del D√≠a</div>
    <div class="sales-list" id="salesDay"></div>

    <!-- 6. VENTAS DEL MES (4 registros visibles) -->
    <div class="section-title">üìÜ Ventas del Mes</div>
    <div class="sales-list" id="salesMonth"></div>

    <!-- 7. RESETEAR SISTEMA -->
    <div class="section-title">üîÑ Resetear Sistema</div>
    <p style="color: #dc2626; font-size: 13px; margin-bottom: 12px;">
      ‚ö†Ô∏è <strong>PELIGRO:</strong> Esta acci√≥n eliminar√° TODOS los datos guardados.
    </p>
    <button class="btn btn-danger" onclick="showResetModal()">Resetear Todo</button>
  </div>

  <!-- ==================== PANTALLA DE AN√ÅLISIS ==================== -->
  <div id="analysisScreen" class="analysis-screen">
    <div class="header">
      <h2>An√°lisis de Ventas</h2>
      <p>KPI B√°sicos - Resumen Ejecutivo</p>
    </div>

    <div class="section-title">üìä KPI Diarios</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Ventas Totales (sin IVA)</div>
        <div class="kpi-value" id="kpiDayTotal">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Cantidad de Ventas</div>
        <div class="kpi-value" id="kpiDayCount">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Ticket Promedio</div>
        <div class="kpi-value" id="kpiDayAverage">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Comisi√≥n Vendedor</div>
        <div class="kpi-value" id="kpiDayCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">üìä KPI Semanales</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Ventas Totales (sin IVA)</div>
        <div class="kpi-value" id="kpiWeekTotal">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Cantidad de Ventas</div>
        <div class="kpi-value" id="kpiWeekCount">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Ticket Promedio</div>
        <div class="kpi-value" id="kpiWeekAverage">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Comisi√≥n Vendedor</div>
        <div class="kpi-value" id="kpiWeekCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">üìä KPI Mensuales</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Ventas Totales (sin IVA)</div>
        <div class="kpi-value" id="kpiMonthTotal">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Cantidad de Ventas</div>
        <div class="kpi-value" id="kpiMonthCount">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Ticket Promedio</div>
        <div class="kpi-value" id="kpiMonthAverage">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Comisi√≥n Vendedor</div>
        <div class="kpi-value" id="kpiMonthCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">üïí Ventas por Hora</div>
    <div class="hourly-chart-container">
      <canvas id="hourlyChart" style="max-height: 200px;"></canvas>
    </div>

    <div style="margin: 24px 0;">
      <button class="btn btn-accent" onclick="showMainScreen()" style="width: 100%;">
        ‚Üê Volver a la pantalla principal
      </button>
    </div>
  </div>

  <!-- ==================== PANTALLA DE CRM ==================== -->
  <div id="crmScreen" class="analysis-screen">
    <div class="header">
      <h2>CRM - Gesti√≥n de Prospectos</h2>
      <p>Base de clientes y seguimiento comercial</p>
    </div>

    <button class="btn btn-accent" onclick="showMainScreen()" style="width: 100%; margin-bottom: 20px;">
      ‚Üê Volver a la pantalla principal
    </button>

    <!-- CONFIGURACI√ìN DEL VENDEDOR -->
    <div class="vendedor-config">
      <h3>Configuraci√≥n de Mensajes</h3>
      <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
        En los mensajes a clientes ¬øC√≥mo quieres que aparezca tu nombre?
      </p>
      <div class="vendedor-input-group">
        <input type="text" id="vendedorNombre" placeholder="Ej: Carlos, Mar√≠a, Juan P√©rez">
        <button onclick="guardarNombreVendedor()">Guardar</button>
      </div>
      <div class="vendedor-current">
        <strong>Nombre actual:</strong> <span id="nombreVendedorActual">No configurado</span>
      </div>
    </div>

    <!-- ACCIONES R√ÅPIDAS -->
    <div class="section-title">‚ö° Acciones R√°pidas</div>
    <div class="actions-grid">
      <button class="btn btn-accent" onclick="showAddProspectModal()">‚ûï Agregar Prospecto</button>
      <button class="btn btn-info" onclick="showImportClientModal()">üìÅ Importar Base</button>
      <button class="btn btn-secondary" onclick="exportProspects()">üì• Exportar Excel</button>
    </div>

    <!-- FILTROS -->
    <div class="section-title">üîç Filtros y B√∫squeda</div>
    <div style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
      <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
        <input type="text" id="searchProspect" placeholder="Buscar por nombre o tel√©fono..." 
               style="flex: 1; min-width: 200px; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px;"
               oninput="filterProspects()">
        <select id="filterStatus" style="min-width: 150px;" onchange="filterProspects()">
          <option value="">Todos los estados</option>
          <option value="Falta contactar">Falta contactar</option>
          <option value="Contactado por WhatsApp">Contactado por WhatsApp</option>
          <option value="Contactado por llamada">Contactado por llamada</option>
          <option value="Contactado por WhatsApp y Llamada">Contactado por WhatsApp y Llamada</option>
        </select>
        <select id="filterProduct" style="min-width: 150px;" onchange="filterProspects()">
          <option value="">Todos los productos</option>
        </select>
      </div>
      <button class="btn btn-secondary" onclick="resetFilters()" style="width: 100%;">
        üîÑ Limpiar Filtros
      </button>
    </div>

    <!-- LISTADO DE PROSPECTOS -->
    <div class="section-title">üë• Listado de Prospectos</div>
    <div class="sales-list" id="prospectList" style="height: 300px;">
      <!-- Prospectos se cargar√°n aqu√≠ -->
    </div>

    <!-- ESTAD√çSTICAS -->
    <div class="section-title">üìä Estad√≠sticas</div>
    <div class="totals-grid">
      <div class="total-cell">
        <div class="total-label">Total Prospectos</div>
        <div class="total-value" id="totalProspects">0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Falta Contactar</div>
        <div class="total-value" id="pendingProspects">0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Contactados</div>
        <div class="total-value" id="contactedProspects">0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">√öltimos 7 d√≠as</div>
        <div class="total-value" id="recentProspects">0</div>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL SUBIR ARCHIVO ==================== -->
  <div id="uploadModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-title">üìÅ Subir Archivo CSV</div>
      
      <div style="margin: 16px 0;">
        <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
          Sube un archivo CSV con el siguiente formato:<br>
          <strong>Fecha/Hora, Monto con IVA, Neto sin IVA, Comisi√≥n, Fecha, Mes</strong>
        </p>
        
        <div class="file-upload-container">
          <div class="file-input-wrapper">
            <button class="file-input-button">üìÇ Seleccionar archivo CSV</button>
            <input type="file" id="csvFile" accept=".csv,text/csv" onchange="handleFileSelect(event)">
          </div>
          <div id="fileName" class="file-name">No se ha seleccionado ning√∫n archivo</div>
        </div>
        
        <div id="filePreview" class="upload-preview" style="display: none;">
          <h4 style="color: var(--accent); margin-bottom: 8px; font-size: 14px;">Vista previa (primeras 5 filas):</h4>
          <table id="previewTable">
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Monto IVA</th>
                <th>Neto</th>
                <th>Comisi√≥n</th>
                <th>Fecha</th>
                <th>Mes</th>
              </tr>
            </thead>
            <tbody id="previewBody">
            </tbody>
          </table>
        </div>
        
        <div id="uploadStats" style="margin-top: 12px; display: none;">
          <div style="color: var(--accent); font-weight: 600; margin-bottom: 4px;">Resumen:</div>
          <div style="font-size: 12px; color: var(--muted);">
            ‚Ä¢ Total de registros: <span id="totalRecords">0</span><br>
            ‚Ä¢ Registros nuevos: <span id="newRecords">0</span><br>
            ‚Ä¢ Total a importar: <span id="importRecords">0</span>
          </div>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="processCSVFile()" id="processBtn" disabled>
          üì• Procesar Archivo
        </button>
        <button class="btn btn-secondary" onclick="hideModal('uploadModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL AGREGAR PROSPECTO - MODIFICADO CON ETIQUETAS ==================== -->
  <div id="addProspectModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-title">‚ûï Agregar Nuevo Prospecto</div>
      
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Nombre y Apellido:</label>
        <input type="text" id="prospectName" placeholder="Ej: Juan P√©rez" 
               style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Tel√©fono:</label>
        <input type="text" id="prospectPhone" placeholder="Ej: 947501990 (sin +56)" inputmode="tel"
               style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Producto(s):</label>
        <input type="text" id="prospectProduct" placeholder="Ej: Neum√°ticos 185/65R15"
               style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Estado:</label>
        <select id="prospectStatus" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
          <option value="Falta contactar">Falta contactar</option>
          <option value="Contactado por WhatsApp">Contactado por WhatsApp</option>
          <option value="Contactado por llamada">Contactado por llamada</option>
          <option value="Contactado por WhatsApp y Llamada">Contactado por WhatsApp y Llamada</option>
        </select>
        
        <!-- NUEVAS ETIQUETAS R√ÅPIDAS -->
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Etiquetas importantes:</label>
        <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" id="prospectTagTrabajo" value="TRABAJO EN CURSO">
            <span class="tag" style="background: #3b82f6; color: white;">üîß TRABAJO EN CURSO</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" id="prospectTagCotizacion" value="COTIZACI√ìN">
            <span class="tag" style="background: #10b981; color: white;">üí∞ COTIZACI√ìN</span>
          </label>
        </div>
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Observaci√≥n inicial (opcional):</label>
        <textarea id="prospectObservation" placeholder="Notas importantes..." rows="3"
                  style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px;"></textarea>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="saveProspect()">üíæ Guardar Prospecto</button>
        <button class="btn btn-secondary" onclick="hideModal('addProspectModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL IMPORTAR CLIENTES ==================== -->
  <div id="importClientModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-title">üìÅ Importar Base de Clientes</div>
      
      <div style="margin: 16px 0;">
        <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
          Sube un archivo Excel (.xlsx) o CSV (.csv) con la siguiente estructura:<br>
          <strong>NombreApellido, Telefono, Producto, Estado, ObservacionInicial, ProximoContacto, Etiqueta</strong><br>
          <em>Estado debe ser "Falta contactar" o "Contactado". ProximoContacto en formato DD/MM/AAAA.</em>
        </p>
        
        <div class="file-upload-container">
          <div class="file-input-wrapper">
            <button class="file-input-button">üìÇ Seleccionar archivo Excel/CSV</button>
            <input type="file" id="clientFile" accept=".csv,.xlsx,.xls,.text/csv" onchange="handleClientFileSelect(event)">
          </div>
          <div id="clientFileName" class="file-name">No se ha seleccionado ning√∫n archivo</div>
        </div>
        
        <div id="clientFilePreview" class="upload-preview" style="display: none; max-height: 300px;">
          <h4 style="color: var(--accent); margin-bottom: 8px; font-size: 14px;">Vista previa (primeras 10 filas):</h4>
          <table id="clientPreviewTable">
            <thead>
              <tr>
                <th>NombreApellido</th>
                <th>Telefono</th>
                <th>Producto</th>
                <th>Estado</th>
                <th>ObservacionInicial</th>
                <th>ProximoContacto</th>
                <th>Etiqueta</th>
              </tr>
            </thead>
            <tbody id="clientPreviewBody">
            </tbody>
          </table>
        </div>
        
        <div id="clientUploadStats" style="margin-top: 12px; display: none;">
          <div style="color: var(--accent); font-weight: 600; margin-bottom: 4px;">Resumen de importaci√≥n:</div>
          <div style="font-size: 12px; color: var(--muted);">
            ‚Ä¢ Total de registros: <span id="clientTotalRecords">0</span><br>
            ‚Ä¢ V√°lidos para importar: <span id="clientValidRecords">0</span><br>
            ‚Ä¢ Duplicados (mismo tel√©fono): <span id="clientDuplicateRecords">0</span><br>
            ‚Ä¢ Ignorados (datos faltantes): <span id="clientIgnoredRecords">0</span>
          </div>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="processClientFile()" id="processClientBtn" disabled>
          üì• Confirmar Importaci√≥n
        </button>
        <button class="btn btn-secondary" onclick="hideModal('importClientModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL DETALLE PROSPECTO ==================== -->
  <div id="prospectDetailModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-title" id="detailProspectName"></div>
      
      <div style="margin: 16px 0;">
        <div style="background: var(--card); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
          <!-- SECCI√ìN MODIFICADA: AHORA CON BOT√ìN DE WHATSAPP -->
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 600; color: var(--accent); margin-right: 8px;">üìû Tel√©fono:</div>
            <div id="detailProspectPhone" style="flex: 1;"></div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-accent" onclick="callProspect()" style="padding: 6px 12px; font-size: 12px;">
                üìû Llamar
              </button>
              <button class="btn btn-whatsapp" onclick="openWhatsApp()" style="padding: 6px 12px; font-size: 12px;">
                üí¨ WhatsApp
              </button>
            </div>
          </div>
          
          <div style="margin-bottom: 8px;">
            <div style="font-weight: 600; color: var(--accent);">üì¶ Producto(s):</div>
            <div id="detailProspectProduct"></div>
          </div>
          
          <div style="margin-bottom: 8px;">
            <div style="font-weight: 600; color: var(--accent);">üìä Estado:</div>
            <select id="detailProspectStatus" style="width: 100%; margin-top: 4px;">
              <option value="Falta contactar">Falta contactar</option>
              <option value="Contactado por WhatsApp">Contactado por WhatsApp</option>
              <option value="Contactado por llamada">Contactado por llamada</option>
              <option value="Contactado por WhatsApp y Llamada">Contactado por WhatsApp y Llamada</option>
            </select>
          </div>
          
          <div style="margin-bottom: 8px;">
            <div style="font-weight: 600; color: var(--accent);">üìÖ Pr√≥ximo contacto:</div>
            <input type="date" id="detailProspectNextContact" style="width: 100%; margin-top: 4px;">
          </div>
          
          <div style="margin-bottom: 8px;">
            <div style="font-weight: 600; color: var(--accent);">üè∑Ô∏è Etiquetas r√°pidas:</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
              <span class="tag" data-tag="Fr√≠o">‚ùÑÔ∏è Fr√≠o</span>
              <span class="tag" data-tag="Tibio">üå§Ô∏è Tibio</span>
              <span class="tag" data-tag="Caliente">üî• Caliente</span>
              <span class="tag" data-tag="COTIZACI√ìN">üí∞ Cotizaci√≥n</span>
              <span class="tag" data-tag="Agenda visita">üìÖ Visita</span>
              <span class="tag" data-tag="TRABAJO EN CURSO">üîß EN TRABAJO</span>
            </div>
            <div id="detailProspectTags" style="margin-top: 8px;"></div>
          </div>
        </div>
        
        <div style="background: var(--card); border-radius: 8px; padding: 12px;">
          <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">üìù Historial de Observaciones:</div>
          <div id="detailProspectObservations" style="max-height: 200px; overflow-y: auto;">
            <!-- Observaciones se cargar√°n aqu√≠ -->
          </div>
          
          <div style="margin-top: 12px;">
            <textarea id="newObservation" placeholder="Agregar nueva observaci√≥n..." rows="2"
                      style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 8px;"></textarea>
            <button class="btn btn-accent" onclick="addObservation()" style="width: 100%; padding: 8px;">
              ‚ûï Agregar Observaci√≥n
            </button>
          </div>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="saveProspectChanges()">üíæ Guardar Cambios</button>
        <button class="btn btn-danger" onclick="confirmDeleteProspect()">üóëÔ∏è Eliminar</button>
        <button class="btn btn-secondary" onclick="hideModal('prospectDetailModal')">‚úó Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="closeDayModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">¬øConfirmar cierre de d√≠a?</div>
      <p style="color: var(--muted); margin-bottom: 16px;">Se vaciar√°n las ventas del d√≠a actual.</p>
      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmCloseDay()">‚úì Confirmar</button>
        <button class="btn btn-secondary" onclick="hideModal('closeDayModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL REEMPLAZADO: ahora cierre de CICLO DE COMISION -->
  <div id="closeCycleModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">¬øConfirmar cierre de Ciclo de Comisi√≥n?</div>
      <p style="color: var(--muted); margin-bottom: 16px;">
        Esta acci√≥n finalizar√° el ciclo de comisi√≥n actual. Los registros del ciclo se archivar√°n en el historial permanente y se reiniciar√°n las ventas del d√≠a y del ciclo actual.
      </p>
      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmCloseCycle()">‚úì Confirmar Cierre de Ciclo</button>
        <button class="btn btn-secondary" onclick="hideModal('closeCycleModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <div id="resetModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">‚ö†Ô∏è ¬øCONFIRMAR RESETEO COMPLETO?</div>
      <p style="color: var(--muted); margin-bottom: 16px;">Se borrar√°n TODOS los datos.</p>
      <div class="modal-buttons">
        <button class="btn btn-danger" onclick="confirmReset()">‚úì S√ç, BORRAR TODO</button>
        <button class="btn btn-secondary" onclick="hideModal('resetModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">üìä Exportar a Excel</div>
      
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Tipo de reporte:</label>
        <select id="exportType" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
          <option value="day">Ventas del D√≠a</option>
          <option value="month">Ventas del Mes</option>
          <option value="permanent">Historial Permanente</option>
        </select>
      </div>

      <div id="dateSelector" style="margin: 16px 0; display: none;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Seleccionar:</label>
        <select id="dateSelect" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
        </select>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmExport()">üì• Exportar</button>
        <button class="btn btn-secondary" onclick="hideModal('exportModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modifyModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-title">‚úèÔ∏è Modificar Ventas</div>
      
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Acci√≥n:</label>
        <select id="modifyAction" onchange="updateModifyAction()" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
          <option value="add">‚ûï Agregar Venta</option>
          <option value="delete">üóëÔ∏è Eliminar Venta</option>
          <option value="search">üîç Buscar en Historial</option>
        </select>
      </div>

      <div id="addSaleSection" style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Fecha de la venta:</label>
        <div class="date-input-wrapper">
          <input type="date" id="saleDate" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 12px;">
        </div>
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Monto con IVA:</label>
        <input type="text" id="saleAmount" placeholder="119000" inputmode="numeric" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
      </div>

      <div id="deleteSaleSection" style="margin: 16px 0; display: none;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Per√≠odo:</label>
        <select id="deletePeriod" onchange="updateDeleteList()" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 12px;">
          <option value="day">Ventas del D√≠a</option>
          <option value="month">Ventas del Mes</option>
          <option value="permanent">Historial Permanente</option>
        </select>
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Seleccionar venta a eliminar:</label>
        <div id="salesListToDelete" style="max-height: 200px; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
        </div>
      </div>

      <div id="searchSaleSection" style="margin: 16px 0; display: none;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Buscar en Historial Permanente:</label>
        <input type="text" id="searchQuery" placeholder="Buscar por mes (ej: 2024-12) o monto..." style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 12px;">
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Resultados:</label>
        <div id="searchResults" style="max-height: 200px; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
          <div style="padding: 12px; color: var(--muted); text-align: center;">Ingrese un t√©rmino de b√∫squeda</div>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmModify()">‚úì Confirmar</button>
        <button class="btn btn-secondary" onclick="hideModal('modifyModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    const COMMISSION_RATE = 0.009;
    let deferredPrompt = null;
    let dailyChartInstance = null;
    let monthlyChartInstance = null;
    let hourlyChartInstance = null;
    
    // Variables para el archivo CSV
    let selectedFile = null;
    let csvData = [];

    // ==================== FUNCIONES PARA CAMBIAR PANTALLAS ====================
    function showMainScreen() {
      document.getElementById('mainScreen').style.display = 'block';
      document.getElementById('analysisScreen').classList.remove('active');
      document.getElementById('crmScreen').classList.remove('active');
      if (typeof refreshUI === 'function') refreshUI();
    }

    function showAnalysisScreen() {
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('analysisScreen').classList.add('active');
      document.getElementById('crmScreen').classList.remove('active');
      if (typeof calculateAndDisplayKPIs === 'function') calculateAndDisplayKPIs();
    }

    function showCRMScreen() {
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('analysisScreen').classList.remove('active');
      document.getElementById('crmScreen').classList.add('active');
      if (typeof loadProspects === 'function') loadProspects();
      if (typeof updateProspectStats === 'function') updateProspectStats();
      if (typeof actualizarNombreVendedor === 'function') actualizarNombreVendedor();
    }

    // ==================== FUNCIONES PARA PROSPECTOS ====================
    let currentProspectId = null;
    let clientFileData = [];
    let clientFileHeaders = [];

    function getProspectsStorage() {
      try {
        const data = localStorage.getItem('prospectos');
        const prospects = data ? JSON.parse(data) : [];
        return prospects;
      } catch (e) {
        console.error('Error leyendo prospectos:', e);
        return [];
      }
    }

    function setProspectsStorage(prospects) {
      try {
        localStorage.setItem('prospectos', JSON.stringify(prospects));
        return true;
      } catch (e) {
        console.error('Error guardando prospectos:', e);
        alert('Error al guardar. Verifica el espacio disponible.');
        return false;
      }
    }

    function generateProspectId() {
      return 'prospect_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showAddProspectModal() {
      document.getElementById('prospectName').value = '';
      document.getElementById('prospectPhone').value = '';
      document.getElementById('prospectProduct').value = '';
      document.getElementById('prospectStatus').value = 'Falta contactar';
      document.getElementById('prospectObservation').value = '';
      // Limpiar checkboxes
      document.getElementById('prospectTagTrabajo').checked = false;
      document.getElementById('prospectTagCotizacion').checked = false;
      showModal('addProspectModal');
    }

    function saveProspect() {
      const name = document.getElementById('prospectName').value.trim();
      const phone = document.getElementById('prospectPhone').value.trim();
      const product = document.getElementById('prospectProduct').value.trim();
      const status = document.getElementById('prospectStatus').value;
      const observation = document.getElementById('prospectObservation').value.trim();
      
      // Obtener etiquetas seleccionadas
      const etiquetas = [];
      if (document.getElementById('prospectTagTrabajo').checked) {
        etiquetas.push('TRABAJO EN CURSO');
      }
      if (document.getElementById('prospectTagCotizacion').checked) {
        etiquetas.push('COTIZACI√ìN');
      }
      
      if (!name || !phone || !product) {
        alert('Por favor completa los campos obligatorios: Nombre, Tel√©fono y Producto.');
        return;
      }
      
      const prospects = getProspectsStorage();
      
      // Verificar si ya existe un prospecto con el mismo tel√©fono
      const existingProspect = prospects.find(p => p.telefono === phone);
      if (existingProspect) {
        alert('Ya existe un prospecto con este n√∫mero de tel√©fono.');
        return;
      }
      
      const newProspect = {
        id: generateProspectId(),
        nombre: name,
        telefono: phone,
        producto: product,
        estado: status,
        etiquetas: etiquetas,
        observaciones: [],
        fechaCreacion: new Date().toISOString(),
        fechaActualizacion: new Date().toISOString()
      };
      
      if (observation) {
        newProspect.observaciones.push({
          fecha: new Date().toISOString(),
          texto: observation
        });
      }
      
      prospects.push(newProspect);
      setProspectsStorage(prospects);
      
      hideModal('addProspectModal');
      if (typeof loadProspects === 'function') loadProspects();
      if (typeof updateProspectStats === 'function') updateProspectStats();
      showToast('‚úÖ Prospecto guardado correctamente');
    }

    function loadProspects() {
      const prospects = getProspectsStorage();
      const container = document.getElementById('prospectList');
      
      if (prospects.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted); font-style: italic;">No hay prospectos registrados.</div>';
        return;
      }
      
      // Actualizar lista de productos para filtro
      updateProductFilter(prospects);
      
      // Aplicar filtros adicionales
      const searchTerm = document.getElementById('searchProspect')?.value.toLowerCase() || '';
      const filterStatus = document.getElementById('filterStatus')?.value || '';
      const filterProduct = document.getElementById('filterProduct')?.value || '';
      
      let filteredProspects = prospects;
      
      if (searchTerm) {
        filteredProspects = filteredProspects.filter(p => 
          p.nombre.toLowerCase().includes(searchTerm) || 
          p.telefono.includes(searchTerm)
        );
      }
      
      if (filterStatus) {
        filteredProspects = filteredProspects.filter(p => p.estado === filterStatus);
      }
      
      if (filterProduct) {
        filteredProspects = filteredProspects.filter(p => p.producto === filterProduct);
      }
      
      container.innerHTML = '';
      
      filteredProspects.forEach(prospect => {
        const div = document.createElement('div');
        div.className = 'prospect-item';
        div.onclick = () => showProspectDetail(prospect.id);
        
        // Determinar clase CSS seg√∫n el estado
        let statusClass = 'status-not-contacted';
        if (prospect.estado === 'Contactado por WhatsApp') {
          statusClass = 'status-whatsapp';
        } else if (prospect.estado === 'Contactado por llamada') {
          statusClass = 'status-call';
        } else if (prospect.estado === 'Contactado por WhatsApp y Llamada') {
          statusClass = 'status-both';
        } else if (prospect.estado === 'Falta contactar') {
          statusClass = 'status-not-contacted';
        }
        
        const lastObservation = prospect.observaciones.length > 0 
          ? prospect.observaciones[prospect.observaciones.length - 1].texto 
          : 'Sin observaciones';
        
        // Mostrar etiquetas si tiene
        let etiquetasHTML = '';
        if (prospect.etiquetas && prospect.etiquetas.length > 0) {
          etiquetasHTML = `<span>üè∑Ô∏è ${prospect.etiquetas.join(', ')}</span>`;
        }
        
        div.innerHTML = `
          <div class="prospect-info">
            <div class="prospect-name">${prospect.nombre}</div>
            <div class="prospect-details">
              <span>üìû ${prospect.telefono}</span>
              <span>üì¶ ${prospect.producto}</span>
              <span class="prospect-status ${statusClass}">${prospect.estado}</span>
              ${etiquetasHTML}
              <span>üìù ${lastObservation.substring(0, 30)}${lastObservation.length > 30 ? '...' : ''}</span>
            </div>
          </div>
          <div style="color: var(--muted); font-size: 12px;">
            üëÅÔ∏è Ver
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function updateProductFilter(prospects) {
      const filterProduct = document.getElementById('filterProduct');
      if (!filterProduct) return;
      
      const products = [...new Set(prospects.map(p => p.producto).filter(p => p))];
      
      filterProduct.innerHTML = '<option value="">Todos los productos</option>';
      products.forEach(product => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        filterProduct.appendChild(option);
      });
    }

    function filterProspects() {
      loadProspects();
      updateProspectStats();
    }

    function resetFilters() {
      document.getElementById('searchProspect').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterProduct').value = '';
      loadProspects();
      updateProspectStats();
    }

    function updateProspectStats() {
      const prospects = getProspectsStorage();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      
      const total = prospects.length;
      const pending = prospects.filter(p => p.estado === 'Falta contactar').length;
      const contacted = prospects.filter(p => p.estado !== 'Falta contactar').length;
      const recent = prospects.filter(p => new Date(p.fechaCreacion) > sevenDaysAgo).length;
      
      document.getElementById('totalProspects').textContent = total;
      document.getElementById('pendingProspects').textContent = pending;
      document.getElementById('contactedProspects').textContent = contacted;
      document.getElementById('recentProspects').textContent = recent;
    }

    function showProspectDetail(id) {
      const prospects = getProspectsStorage();
      const prospect = prospects.find(p => p.id === id);
      
      if (!prospect) {
        alert('Prospecto no encontrado.');
        return;
      }
      
      currentProspectId = id;
      
      document.getElementById('detailProspectName').textContent = prospect.nombre;
      document.getElementById('detailProspectPhone').textContent = prospect.telefono;
      document.getElementById('detailProspectProduct').textContent = prospect.producto;
      document.getElementById('detailProspectStatus').value = prospect.estado;
      document.getElementById('detailProspectNextContact').value = prospect.proximoContacto || '';
      
      // Cargar etiquetas
      const tagsContainer = document.getElementById('detailProspectTags');
      tagsContainer.innerHTML = '';
      if (prospect.etiquetas && prospect.etiquetas.length > 0) {
        prospect.etiquetas.forEach(tag => {
          const span = document.createElement('span');
          span.className = 'tag active';
          span.textContent = tag;
          span.style.marginRight = '4px';
          span.style.marginBottom = '4px';
          tagsContainer.appendChild(span);
        });
      }
      
      // Cargar observaciones
      const obsContainer = document.getElementById('detailProspectObservations');
      obsContainer.innerHTML = '';
      
      if (prospect.observaciones.length === 0) {
        obsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted); font-style: italic;">No hay observaciones registradas.</div>';
      } else {
        // Mostrar observaciones m√°s recientes primero
        [...prospect.observaciones].reverse().forEach(obs => {
          const div = document.createElement('div');
          div.className = 'observation-item';
          const date = new Date(obs.fecha);
          div.innerHTML = `
            <div class="observation-date">${date.toLocaleString('es-CL')}</div>
            <div class="observation-text">${obs.texto}</div>
          `;
          obsContainer.appendChild(div);
        });
      }
      
      // Configurar eventos para etiquetas r√°pidas
      document.querySelectorAll('.tag[data-tag]').forEach(tag => {
        tag.onclick = function() {
          const tagText = this.getAttribute('data-tag');
          addTagToProspect(tagText);
        };
      });
      
      showModal('prospectDetailModal');
    }

    function addTagToProspect(tag) {
      if (!currentProspectId) return;
      
      const prospects = getProspectsStorage();
      const index = prospects.findIndex(p => p.id === currentProspectId);
      
      if (index === -1) return;
      
      if (!prospects[index].etiquetas) {
        prospects[index].etiquetas = [];
      }
      
      if (!prospects[index].etiquetas.includes(tag)) {
        prospects[index].etiquetas.push(tag);
        setProspectsStorage(prospects);
        showProspectDetail(currentProspectId);
        showToast(`üè∑Ô∏è Etiqueta "${tag}" agregada`);
      }
    }

    function addObservation() {
      const textarea = document.getElementById('newObservation');
      const text = textarea.value.trim();
      
      if (!text) {
        alert('Por favor escribe una observaci√≥n.');
        return;
      }
      
      if (!currentProspectId) return;
      
      const prospects = getProspectsStorage();
      const index = prospects.findIndex(p => p.id === currentProspectId);
      
      if (index === -1) return;
      
      if (!prospects[index].observaciones) {
        prospects[index].observaciones = [];
      }
      
      prospects[index].observaciones.push({
        fecha: new Date().toISOString(),
        texto: text
      });
      
      prospects[index].fechaActualizacion = new Date().toISOString();
      
      setProspectsStorage(prospects);
      textarea.value = '';
      showProspectDetail(currentProspectId);
      showToast('‚úÖ Observaci√≥n agregada');
    }

    function saveProspectChanges() {
      if (!currentProspectId) return;
      
      const prospects = getProspectsStorage();
      const index = prospects.findIndex(p => p.id === currentProspectId);
      
      if (index === -1) return;
      
      prospects[index].estado = document.getElementById('detailProspectStatus').value;
      prospects[index].proximoContacto = document.getElementById('detailProspectNextContact').value;
      prospects[index].fechaActualizacion = new Date().toISOString();
      
      setProspectsStorage(prospects);
      hideModal('prospectDetailModal');
      loadProspects();
      updateProspectStats();
      showToast('‚úÖ Cambios guardados');
    }

    // ------------------------
    // FUNCIONES AUXILIARES (mostrar/ocultar modales, toast)
    // Implementaciones simples por si no existieran en la versi√≥n actual del archivo
    function showModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
    }
    function hideModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('active');
    }
    function showToast(msg, timeout = 2500) {
      // Implementaci√≥n minimalista: usar alert si no hay toast implementado
      try {
        // Intentar usar un toast si existe
        if (typeof window.showAppToast === 'function') {
          window.showAppToast(msg);
        } else {
          // fallback: console + temporal elemento
          console.log('TOAST:', msg);
          const t = document.createElement('div');
          t.textContent = msg;
          t.style.position = 'fixed';
          t.style.left = '50%';
          t.style.bottom = '20px';
          t.style.transform = 'translateX(-50%)';
          t.style.background = 'rgba(0,0,0,0.8)';
          t.style.color = 'white';
          t.style.padding = '10px 16px';
          t.style.borderRadius = '8px';
          t.style.zIndex = 2000;
          document.body.appendChild(t);
          setTimeout(() => t.remove(), timeout);
        }
      } catch (e) {
        console.log(msg);
      }
    }

    // =====================================================================
    // Cambios introducidos: "Cierre de Ciclo de Comisi√≥n"
    // - Se reemplazan las referencias de "Cerrar Mes" por "Cerrar Ciclo" en UI.
    // - Se a√±ade l√≥gica para que, cuando el usuario confirme el cierre de ciclo,
    //   los registros del ciclo actual (ventas d√≠a/mes) se archiven en un historial
    //   permanente y las colecciones actuales se reseteen.
    // - La acci√≥n la determina el usuario manualmente (no por calendario).
    // =====================================================================

    // Llaves de almacenamiento usadas por la app (compatibilidad con variantes)
    const STORAGE_KEYS = {
      salesDayCandidates: ['ventasDia', 'salesDay', 'daySales', 'ventas_dia'],
      salesMonthCandidates: ['ventasMes', 'salesMonth', 'monthSales', 'ventas_mes'],
      permanentHistoryKey: 'historialVentas' // ser√° un array de ciclos archivados
    };

    function readFirstExistingArray(keys) {
      for (const k of keys) {
        try {
          const raw = localStorage.getItem(k);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) return { key: k, value: parsed };
            // if stored as object with items
            if (parsed && Array.isArray(parsed.items)) return { key: k, value: parsed.items };
          }
        } catch (e) {
          console.warn('No se pudo leer clave', k, e);
        }
      }
      return { key: null, value: [] };
    }

    function writeArrayToKey(key, arr) {
      try {
        localStorage.setItem(key, JSON.stringify(arr));
        return true;
      } catch (e) {
        console.error('Error escribiendo en localStorage', key, e);
        return false;
      }
    }

    function appendToPermanentHistory(archiveEntry) {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.permanentHistoryKey);
        const current = raw ? JSON.parse(raw) : [];
        current.push(archiveEntry);
        localStorage.setItem(STORAGE_KEYS.permanentHistoryKey, JSON.stringify(current));
        return true;
      } catch (e) {
        console.error('Error archivando ciclo en historial permanente', e);
        return false;
      }
    }

    // Mostrar modal de cierre de ciclo
    function showCloseCycleModal() {
      showModal('closeCycleModal');
    }

    // Confirmar cierre de ciclo: archivar y resetear colecciones actuales
    function confirmCloseCycle() {
      // 1) Leer ventas del d√≠a/mes desde las posibles llaves (compatibilidad)
      const dayData = readFirstExistingArray(STORAGE_KEYS.salesDayCandidates);
      const monthData = readFirstExistingArray(STORAGE_KEYS.salesMonthCandidates);

      // 2) Preparar objeto de archivo
      const now = new Date();
      const archive = {
        id: 'cycle_' + now.toISOString(),
        closedAt: now.toISOString(),
        dayKeyUsed: dayData.key,
        monthKeyUsed: monthData.key,
        daySales: Array.isArray(dayData.value) ? dayData.value : [],
        monthSales: Array.isArray(monthData.value) ? monthData.value : [],
        note: 'Cierre de ciclo realizado por usuario'
      };

      // 3) Guardar en historial permanente
      const okArchive = appendToPermanentHistory(archive);

      // 4) Resetear colecciones actuales (el usuario determin√≥ cierre)
      const clearedDay = writeArrayToKey(dayData.key || STORAGE_KEYS.salesDayCandidates[0], []);
      const clearedMonth = writeArrayToKey(monthData.key || STORAGE_KEYS.salesMonthCandidates[0], []);

      // 5) Si todo ok, cerrar modal y refrescar UI
      hideModal('closeCycleModal');
      if (okArchive && clearedDay && clearedMonth) {
        if (typeof refreshUI === 'function') refreshUI();
        showToast('‚úÖ Ciclo de comisi√≥n cerrado y archivado correctamente');
      } else {
        showToast('‚ö†Ô∏è Ocurri√≥ un problema al cerrar el ciclo. Revisa la consola.');
      }
    }

    // =====================================================================
    // Nota:
    // - Esta implementaci√≥n intenta ser compatible con distintas claves de
    //   almacenamiento que la app podr√≠a usar (por versiones anteriores).
    // - Archiva el contenido tal cual estaba en el momento del cierre y luego
    //   reinicia los arrays que representan ventas del d√≠a y del ciclo (mes).
    // - No elimina el historial permanente previo, simplemente lo expande.
    // =====================================================================

    // Resto de funcionalidades (placeholders si faltan en la versi√≥n actual)
    // Aqu√≠ a√±adimos implementaciones b√°sicas/fallback para funciones que la UI usa
    // y que podr√≠an no existir en la versi√≥n del archivo provisto, evitando errores.

    function showCloseDayModal() {
      showModal('closeDayModal');
    }

    function confirmCloseDay() {
      // Intento de compatibilidad: buscar la llave de ventas d√≠a y vaciarla
      const dayData = readFirstExistingArray(STORAGE_KEYS.salesDayCandidates);
      const cleared = writeArrayToKey(dayData.key || STORAGE_KEYS.salesDayCandidates[0], []);
      hideModal('closeDayModal');
      if (cleared) {
        if (typeof refreshUI === 'function') refreshUI();
        showToast('‚úÖ Ventas del d√≠a reiniciadas');
      } else {
        showToast('‚ö†Ô∏è No se pudo reiniciar ventas del d√≠a');
      }
    }

    // Placeholder: eliminar √∫ltima venta (si no existe implementaci√≥n)
    function deleteLastSale() {
      // Intentar manipular la primera clave de ventas del d√≠a encontrada
      const dayData = readFirstExistingArray(STORAGE_KEYS.salesDayCandidates);
      const arr = Array.isArray(dayData.value) ? dayData.value : [];
      if (!arr || arr.length === 0) {
        showToast('No hay ventas para eliminar');
        return;
      }
      arr.pop();
      const ok = writeArrayToKey(dayData.key || STORAGE_KEYS.salesDayCandidates[0], arr);
      if (ok) {
        if (typeof refreshUI === 'function') refreshUI();
        showToast('‚úÖ √öltima venta eliminada');
      } else {
        showToast('‚ö†Ô∏è No se pudo eliminar la venta');
      }
    }

    // Placeholders m√≠nimos para evitar errores si funciones no est√°n definidas:
    function addSale() {
      // Intento simple: a√±adir a la primera clave de ventas del d√≠a disponible
      const rawAmount = (document.getElementById('amountInput')?.value || '').replace(/\D/g,'');
      if (!rawAmount) {
        alert('Ingresa un monto v√°lido');
        return;
      }
      const amount = parseInt(rawAmount, 10);
      const dayKey = readFirstExistingArray(STORAGE_KEYS.salesDayCandidates).key || STORAGE_KEYS.salesDayCandidates[0];
      const existingRaw = localStorage.getItem(dayKey);
      const existing = existingRaw ? JSON.parse(existingRaw) : [];
      existing.push({
        id: 'sale_' + Date.now(),
        amountWithVat: amount,
        net: Math.round(amount / 1.19),
        commission: +(Math.round(amount * COMMISSION_RATE * 100) / 100),
        createdAt: new Date().toISOString()
      });
      try {
        localStorage.setItem(dayKey, JSON.stringify(existing));
        if (typeof refreshUI === 'function') refreshUI();
        document.getElementById('amountInput').value = '';
        showToast('‚úÖ Venta agregada');
      } catch (e) {
        console.error('Error guardando venta', e);
        alert('No se pudo guardar la venta. Ver consola.');
      }
    }

    // Fallbacks para otras funciones referenciadas en el HTML que podr√≠an no existir
    if (typeof showUploadModal !== 'function') {
      function showUploadModal() { showModal('uploadModal'); }
    }
    if (typeof showExportModal !== 'function') {
      function showExportModal() { showModal('exportModal'); }
    }
    if (typeof showModifyModal !== 'function') {
      function showModifyModal() { showModal('modifyModal'); }
    }
    if (typeof showImportClientModal !== 'function') {
      function showImportClientModal() { showModal('importClientModal'); }
    }
    if (typeof exportProspects !== 'function') {
      function exportProspects() {
        showToast('Funcionalidad de exportar prospectos no implementada en esta versi√≥n');
      }
    }
    if (typeof processCSVFile !== 'function') {
      function processCSVFile() {
        showToast('Procesamiento de CSV no implementado en este entorno');
      }
    }
    if (typeof processClientFile !== 'function') {
      function processClientFile() {
        showToast('Procesamiento de archivo de clientes no implementado en este entorno');
      }
    }

    // Inicializaci√≥n ligera
    document.addEventListener('DOMContentLoaded', () => {
      // Mostrar pantalla principal por defecto y refrescar UI si existe
      showMainScreen();
    });
  </script>
</body>
</html>
``` 

Resumen de lo entendido antes de aplicar cambios:
- El "cierre de mes" no debe depender del calendario: el usuario decide cu√°ndo cerrar el ciclo de comisiones.
- Se requiere cambiar etiquetas y la l√≥gica para reflejar "Cierre de Ciclo de Comisi√≥n" en lugar de "Cerrar Mes".
- La acci√≥n de cierre de ciclo debe archivar los registros del ciclo actual en un historial permanente y reiniciar las colecciones actuales (ventas d√≠a y ventas del ciclo), sin depender del fin de mes autom√°tico.
- No preguntar m√°s: apliqu√© los cambios de interfaz (bot√≥n, modal, textos) y a√±ad√≠ l√≥gica para archivar el ciclo y resetear las colecciones (con compatibilidad hacia distintas claves de localStorage). Tambi√©n a√±ad√≠ fallbacks para evitar errores si otras funciones no existieran en la versi√≥n actual del archivo.
