<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f7c600">
  <meta name="description" content="Sistema de comisiones exclusivo para vendedores autorizados">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Comisiones Exclusivo">
  <title>Sistema de Comisiones Exclusivo</title>
  <link rel="manifest" href="#" id="manifest-placeholder">
  <style>
    /* ============================================ */
    /* ESTILOS DEL SISTEMA DE ACTIVACI√ìN (a√±adir al inicio) */
    /* ============================================ */
    #activationScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f0f10;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .activation-container {
      background: #1a1a1c;
      padding: 30px;
      border-radius: 16px;
      max-width: 450px;
      width: 100%;
      text-align: center;
      border: 2px solid #2a2a2a;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .activation-logo {
      font-size: 48px;
      margin-bottom: 20px;
      display: block;
    }
    
    .activation-title {
      color: #f7c600;
      font-size: 24px;
      margin-bottom: 15px;
      font-weight: 700;
    }
    
    .activation-subtitle {
      color: #ffffff;
      font-size: 16px;
      margin-bottom: 25px;
      line-height: 1.5;
    }
    
    .vendedor-info {
      background: rgba(247, 198, 0, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 25px 0;
      border: 1px solid rgba(247, 198, 0, 0.3);
    }
    
    .vendedor-label {
      font-size: 14px;
      color: #999999;
      margin-bottom: 8px;
      display: block;
    }
    
    .vendedor-value {
      font-size: 22px;
      color: #f7c600;
      font-weight: 700;
      margin-bottom: 15px;
    }
    
    .device-info {
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .device-label {
      font-size: 12px;
      color: #999999;
      margin-bottom: 5px;
      display: block;
    }
    
    .device-id {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #3b82f6;
      font-weight: 600;
      word-break: break-all;
    }
    
    .activation-warning {
      background: rgba(220, 38, 38, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      border: 1px solid rgba(220, 38, 38, 0.3);
    }
    
    .warning-text {
      font-size: 13px;
      color: #fca5a5;
      line-height: 1.5;
    }
    
    .activation-input {
      width: 100%;
      padding: 16px;
      background: #0f0f10;
      color: #ffffff;
      border: 2px solid #2a2a2a;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      letter-spacing: 2px;
    }
    
    .activation-input:focus {
      outline: none;
      border-color: #f7c600;
      box-shadow: 0 0 0 3px rgba(247, 198, 0, 0.2);
    }
    
    .btn-activation {
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      width: 100%;
      margin-top: 10px;
    }
    
    .btn-activation-primary {
      background: #f7c600;
      color: #111111;
    }
    
    .btn-activation-primary:hover {
      background: #d1a400;
      box-shadow: 0 6px 20px rgba(247, 198, 0, 0.4);
    }
    
    .btn-activation-secondary {
      background: #1a1a1c;
      color: #ffffff;
      border: 2px solid #2a2a2a;
    }
    
    .activation-footer {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #2a2a2a;
    }
    
    .footer-text {
      font-size: 12px;
      color: #999999;
      line-height: 1.5;
    }
    
    /* Estilos existentes de tu app */
    :root {
      --bg: #0f0f10;
      --card: #1a1a1c;
      --text: #ffffff;
      --accent: #f7c600;
      --accent-strong: #d1a400;
      --muted: #999999;
      --border: #2a2a2a;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 8px;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    .header {
      background: var(--accent);
      padding: 16px 12px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(247, 198, 0, 0.3);
    }
    
    .header h2 {
      margin: 0;
      color: #111111;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
    }
    
    .header p {
      margin: 4px 0 0 0;
      color: #111111;
      font-size: 13px;
      opacity: 0.85;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    
    .totals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .total-cell {
      background: var(--card);
      border-radius: 8px;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .total-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .total-value {
      font-size: 18px;
      color: var(--accent);
      font-weight: 700;
      word-break: break-word;
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      flex: 1;
      background: var(--card);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      padding: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input[type="text"]:focus {
      border-color: var(--accent);
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: scale(0.97);
    }
    
    .btn-accent {
      background: var(--accent);
      color: #111111;
    }
    
    .btn-accent:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .btn-danger {
      background: #dc2626;
      color: #ffffff;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-info {
      background: #3b82f6;
      color: #ffffff;
    }
    
    .btn-info:hover {
      background: #2563eb;
    }
    
    .btn-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    
    .btn-container .btn {
      flex: 1;
      min-width: 140px;
    }
    
    .sales-list {
      background: var(--card);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      height: 250px;
      overflow-y: auto;
      border: 1px solid var(--border);
    }
    
    .sales-list:empty::after {
      content: "(sin ventas)";
      color: var(--muted);
      font-style: italic;
      display: block;
      text-align: center;
      padding: 40px;
    }
    
    .sale-item {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      line-height: 1.6;
      min-height: 40px;
    }
    
    .sale-item:last-child {
      border-bottom: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      border: 2px solid var(--border);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
    }
    
    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    
    .modal-buttons .btn {
      flex: 1;
    }
    
    .install-prompt {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .install-prompt.show {
      display: flex;
    }
    
    .install-prompt-text {
      flex: 1;
      color: #111111;
      font-size: 14px;
      font-weight: 600;
    }
    
    .install-prompt .btn {
      background: #111111;
      color: var(--accent);
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .analysis-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .analysis-screen.active {
      display: block;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .kpi-card {
      background: var(--card);
      border-radius: 8px;
      padding: 16px 12px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .kpi-period {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .kpi-title {
      font-size: 13px;
      color: var(--accent);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .kpi-value {
      font-size: 18px;
      color: var(--text);
      font-weight: 700;
      word-break: break-word;
    }
    
    .hourly-chart-container {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    .file-upload-container {
      margin: 16px 0;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-button {
      background: var(--accent);
      color: #111111;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: block;
      text-align: center;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .file-input-button:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .file-name {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      word-break: break-all;
    }
    
    .upload-preview {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
    }
    
    .upload-preview table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .upload-preview th {
      text-align: left;
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--accent);
      font-size: 11px;
    }
    
    .upload-preview td {
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    
    input[type="date"] {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      width: 100%;
      position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.7;
      cursor: pointer;
      padding: 4px;
      margin-left: 4px;
    }
    
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
    }
    
    .date-input-wrapper {
      position: relative;
      width: 100%;
    }
    
    .date-input-wrapper::after {
      content: "üìÖ";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      font-size: 16px;
      pointer-events: none;
    }
    
    select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px 36px 12px 12px;
      font-size: 14px;
      width: 100%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23f7c600' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 16px 0;
    }
    
    .actions-grid .btn {
      width: 100%;
    }
    
    .tag {
      display: inline-block;
      padding: 4px 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    
    .tag:hover {
      background: var(--accent);
      color: #111111;
      transform: scale(1.05);
    }
    
    .tag.active {
      background: var(--accent);
      color: #111111;
      font-weight: 600;
    }
    
    .prospect-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .prospect-item:hover {
      background: rgba(247, 198, 0, 0.1);
    }
    
    .prospect-info {
      flex: 1;
    }
    
    .prospect-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .prospect-details {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .prospect-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-not-contacted {
      background: #dc2626;
      color: white;
    }
    
    .status-contacted {
      background: #10b981;
      color: white;
    }
    
    .status-whatsapp {
      background: #25D366;
      color: white;
    }
    
    .status-call {
      background: #3b82f6;
      color: white;
    }
    
    .status-both {
      background: linear-gradient(135deg, #25D366 0%, #3b82f6 100%);
      color: white;
    }
    
    .observation-item {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    
    .observation-date {
      color: var(--accent);
      font-size: 10px;
      margin-bottom: 2px;
    }
    
    .observation-text {
      color: var(--text);
    }
    
    .btn-whatsapp {
      background: #25D366;
      color: white;
    }
    
    .btn-whatsapp:hover {
      background: #1da851;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }
    
    .vendedor-config {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    .vendedor-config h3 {
      font-size: 16px;
      color: var(--accent);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .vendedor-config h3::before {
      content: "üë§";
      font-size: 18px;
    }
    
    .vendedor-input-group {
      display: flex;
      gap: 8px;
    }
    
    .vendedor-input-group input {
      flex: 1;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
    }
    
    .vendedor-input-group button {
      background: var(--accent);
      color: #111111;
      border: none;
      border-radius: 8px;
      padding: 0 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vendedor-input-group button:hover {
      background: var(--accent-strong);
    }
    
    .vendedor-current {
      margin-top: 12px;
      padding: 10px;
      background: rgba(247, 198, 0, 0.1);
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    
    .vendedor-current strong {
      color: var(--accent);
    }
    
    .btn-flashing {
      background: #dc2626;
      color: #ffffff;
      position: relative;
      overflow: hidden;
      animation: flashing 0.7s infinite;
      box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
    }
    
    .btn-flashing:hover {
      background: #b91c1c;
      animation: flashing-fast 0.4s infinite;
    }
    
    .btn-nuclear {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #7f1d1d 100%);
      color: white;
      border: 2px solid #f87171;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
    }
    
    .btn-nuclear:hover {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1b 100%);
      box-shadow: 0 0 30px rgba(220, 38, 38, 0.8);
      transform: scale(1.02);
    }
    
    .btn-nuclear:active {
      animation: nuclear-pulse 0.3s;
    }
    
    @keyframes flashing {
      0% { 
        background-color: #dc2626;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
      }
      50% { 
        background-color: #ff0000;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      }
      100% { 
        background-color: #dc2626;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
      }
    }
    
    @keyframes flashing-fast {
      0% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
      25% { 
        background-color: #ff0000;
        box-shadow: 0 0 25px rgba(255, 0, 0, 1);
      }
      50% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
      75% { 
        background-color: #ff0000;
        box-shadow: 0 0 25px rgba(255, 0, 0, 1);
      }
      100% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
    }
    
    @keyframes nuclear-pulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
    
    @media (max-width: 768px) {
      .header h2 { font-size: 18px; }
      .total-value { font-size: 16px; }
      .total-label { font-size: 10px; }
      .btn-container { flex-direction: column; }
      .btn-container .btn { min-width: 100%; }
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-value { font-size: 16px; }
      .sales-list { height: 200px; }
      .actions-grid { grid-template-columns: 1fr; }
      .vendedor-input-group { flex-direction: column; }
      .vendedor-input-group button { width: 100%; padding: 12px; }
    }
    
    @media (max-width: 480px) {
      body { padding: 4px; }
      .header h2 { font-size: 16px; }
      .total-value { font-size: 14px; }
      .total-label { font-size: 9px; }
      .totals-grid { gap: 6px; }
      .modal-content {
        padding: 16px;
        max-width: 95%;
      }
      .kpi-value { font-size: 14px; }
      .sales-list { height: 180px; }
    }
  </style>
</head>
<body>
  <!-- ============================================ -->
  <!-- PANTALLA DE ACTIVACI√ìN (MUY IMPORTANTE - Se muestra primero) -->
  <!-- ============================================ -->
  <div id="activationScreen">
    <div class="activation-container">
      <div class="activation-logo">üîí</div>
      <h1 class="activation-title">SISTEMA DE COMISIONES EXCLUSIVO</h1>
      <p class="activation-subtitle">
        Esta aplicaci√≥n es de uso exclusivo para vendedores autorizados de<br>
        <strong style="color: #f7c600;">Neum√°ticos y Llantas del Pac√≠fico</strong>
      </p>
      
      <div class="vendedor-info">
        <span class="vendedor-label">VENDEDOR ASIGNADO:</span>
        <div class="vendedor-value" id="assignedVendor">[VENDEDOR AUTORIZADO]</div>
        
        <div class="device-info">
          <span class="device-label">IDENTIFICADOR DE DISPOSITIVO:</span>
          <div class="device-id" id="deviceIdDisplay">Cargando dispositivo...</div>
        </div>
      </div>
      
      <div class="activation-warning">
        <p class="warning-text">
          ‚ö†Ô∏è <strong>ADVERTENCIA DE SEGURIDAD:</strong><br>
          Esta aplicaci√≥n est√° vinculada a un solo dispositivo.<br>
          Cualquier intento de compartir o usar en otro dispositivo<br>
          resultar√° en el bloqueo permanente del sistema.
        </p>
      </div>
      
      <div id="activationSection">
        <input type="text" 
               id="activationCode" 
               class="activation-input" 
               placeholder="Ingresa tu c√≥digo de activaci√≥n"
               maxlength="8"
               autocomplete="off">
        
        <button class="btn-activation btn-activation-primary" onclick="attemptActivation()">
          üîì ACTIVAR SISTEMA
        </button>
      </div>
      
      <div class="activation-footer">
        <p class="footer-text">
          <strong>Para soporte t√©cnico o activaci√≥n:</strong><br>
          Contacta al administrador del sistema<br>
          üìß administrador@neumaticosypacifico.cl<br>
          üìû +56 9 1234 5678
        </p>
      </div>
    </div>
  </div>
  
  <!-- ============================================ -->
  <!-- CONTENIDO PRINCIPAL DE LA APP (OCULTO INICIALMENTE) -->
  <!-- ============================================ -->
  <div id="mainAppContent" style="display: none;">
    <!-- Navegaci√≥n interna invisible -->
    <div id="navigationHistory" style="display: none;"></div>
    
    <div id="mainScreen">
      <div id="installPrompt" class="install-prompt">
        <div class="install-prompt-text">
          üì± Instala esta app en tu celular para usarla offline
        </div>
        <button class="btn" onclick="installApp()">Instalar</button>
      </div>

      <div class="header">
        <h2>Neum√°ticos y Llantas del Pac√≠fico</h2>
        <p>Sistema de Comisiones - <span id="currentVendorName"></span></p>
      </div>

      <div class="section-title">üìä Resumen de Ventas</div>
      <div class="totals-grid">
        <div class="total-cell">
          <div class="total-label">Total D√≠a (con IVA)</div>
          <div class="total-value" id="dayWithVat">$ 0</div>
        </div>
        <div class="total-cell">
          <div class="total-label">Total D√≠a (sin IVA)</div>
          <div class="total-value" id="dayWithoutVat">$ 0</div>
        </div>
        <div class="total-cell">
          <div class="total-label">Comisi√≥n D√≠a</div>
          <div class="total-value" id="dayCommission">$ 0</div>
        </div>
        <div class="total-cell">
          <div class="total-label">Total Ciclo (con IVA)</div>
          <div class="total-value" id="cycleWithVat">$ 0</div>
        </div>
        <div class="total-cell">
          <div class="total-label">Total Ciclo (sin IVA)</div>
          <div class="total-value" id="cycleWithoutVat">$ 0</div>
        </div>
        <div class="total-cell">
          <div class="total-label">Comisi√≥n Ciclo</div>
          <div class="total-value" id="cycleCommission">$ 0</div>
        </div>
      </div>

      <div class="section-title">‚ûï Agregar Venta</div>
      <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
        Introduce el <strong>monto TOTAL con IVA</strong> (ejemplo: 119000):
      </p>
      <div class="input-group">
        <input type="text" id="amountInput" placeholder="119000" inputmode="numeric">
        <button class="btn btn-accent" onclick="addSale()">Agregar</button>
      </div>
      
      <button class="btn btn-danger" onclick="deleteLastSale()" style="width: 100%; margin-top: 8px; margin-bottom: 24px;">
        üóëÔ∏è Eliminar √öltima Venta
      </button>

      <div class="section-title">‚öôÔ∏è Acciones</div>
      <div class="actions-grid">
        <button class="btn btn-danger" onclick="showCloseDayModal()">Cerrar D√≠a</button>
        <button class="btn btn-danger" onclick="showCloseCycleModal()">Cerrar Ciclo Comisiones</button>
        <button class="btn btn-accent" onclick="showAnalysisScreen()">An√°lisis de Ventas</button>
        <button class="btn btn-accent" onclick="showModifyModal()">Modificar Ventas</button>
        <button class="btn btn-info" onclick="showCRMScreen()">Gesti√≥n de Clientes</button>
        <button class="btn btn-secondary" onclick="showExportModal()">Exportar Ventas</button>
        <button class="btn btn-info" onclick="showUploadModal()">Subir Archivos Ventas</button>
      </div>

      <div class="section-title">üìÖ Ventas del D√≠a</div>
      <div class="sales-list" id="salesDay"></div>

      <div class="section-title">üìÜ Ventas del Ciclo Actual</div>
      <div class="sales-list" id="salesCycle"></div>

      <!-- NUEVA SECCI√ìN: HISTORIAL COMPLETO DE VENTAS -->
      <div class="section-title">üìã Historial Completo de Ventas</div>
      <div class="sales-list" id="salesHistory"></div>

      <div class="section-title">üîÑ Resetear Sistema</div>
      <p style="color: #dc2626; font-size: 13px; margin-bottom: 12px;">
        ‚ö†Ô∏è <strong>PELIGRO:</strong> Esta acci√≥n eliminar√° TODOS los datos guardados.
      </p>
      <button class="btn btn-danger" onclick="showResetModal()">Resetear Todo</button>

      <!-- NUEVO BOT√ìN DE DESINSTALACI√ìN COMPLETA -->
      <div class="section-title" style="margin-top: 40px; border-top: 2px solid #dc2626; padding-top: 20px;">
        ‚ò¢Ô∏è DESINSTALACI√ìN COMPLETA
      </div>
      <p style="color: #dc2626; font-size: 13px; margin-bottom: 12px;">
        ‚ö†Ô∏è <strong>ADVERTENCIA NUCLEAR:</strong> Esto eliminar√° la aplicaci√≥n completamente del dispositivo.
        Se borrar√°n todos los datos, cache, y la app dejar√° de funcionar.
      </p>
      <button class="btn btn-nuclear" onclick="showUninstallModal()" style="width: 100%; margin-bottom: 40px; padding: 16px; font-size: 16px;">
        ‚ò¢Ô∏è DESINSTALAR APP COMPLETAMENTE DEL M√ìVIL
      </button>
    </div>

    <!-- MODAL DE DESINSTALACI√ìN NUEVO -->
    <div id="uninstallModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">‚ò¢Ô∏è ¬øDESINSTALAR APP COMPLETAMENTE?</div>
        <div style="margin: 16px 0; padding: 16px; background: rgba(220, 38, 38, 0.1); border-radius: 8px; border: 2px solid #dc2626;">
          <p style="color: white; font-weight: 600; margin-bottom: 12px;">‚ö†Ô∏è ADVERTENCIA EXTREMA:</p>
          <ul style="color: #fca5a5; font-size: 13px; line-height: 1.6; padding-left: 20px;">
            <li>Se eliminar√°n TODOS los datos permanentemente</li>
            <li>Se borrar√° el cache de la aplicaci√≥n</li>
            <li>La app se remover√° del dispositivo</li>
            <li>No podr√°s acceder a los datos sin reinstalar</li>
            <li>Esta acci√≥n NO se puede deshacer</li>
          </ul>
        </div>
        <p style="color: var(--muted); margin-bottom: 16px; font-size: 13px;">
          Si est√°s seguro, escribe <strong>"DESINSTALAR"</strong> en el siguiente campo:
        </p>
        <input type="text" id="uninstallConfirm" placeholder="Escribe DESINSTALAR aqu√≠" 
               style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); 
                      border: 2px solid #dc2626; border-radius: 8px; margin-bottom: 16px;"
               oninput="checkUninstallConfirmation()">
        <div class="modal-buttons">
          <button class="btn btn-nuclear" id="confirmUninstallBtn" onclick="performCompleteUninstall()" disabled>
            ‚ò¢Ô∏è CONFIRMAR DESINSTALACI√ìN COMPLETA
          </button>
          <button class="btn btn-secondary" onclick="hideModal('uninstallModal')">‚úó Cancelar</button>
        </div>
      </div>
    </div>

    <!-- ... El resto de tu HTML original permanece igual ... -->
    <!-- (Incluyendo analysisScreen, crmScreen, y todos los otros modales) -->
    
  </div>

  <!-- ============================================ -->
  <!-- SCRIPT DEL SISTEMA DE ACTIVACI√ìN (a√±adir al inicio) -->
  <!-- ============================================ -->
  <script>
    // ============================================
    // SISTEMA DE ACTIVACI√ìN - CONFIGURACI√ìN POR VENDEDOR
    // ============================================
    
    // CONFIGURACI√ìN POR VENDEDOR - EDITA ESTAS 2 L√çNEAS SOLAMENTE:
    const VENDEDOR_CONFIG = {
      nombre: "CARLOS RODR√çGUEZ",      // CAMBIA: Poner nombre del vendedor
      codigo: "CARL7890"               // CAMBIA: Poner c√≥digo √∫nico (8 d√≠gitos)
    };
    
    // Funci√≥n para generar ID √∫nico del dispositivo
    function generateDeviceId() {
      try {
        const data = [
          navigator.userAgent,
          navigator.platform,
          navigator.language,
          screen.width + 'x' + screen.height,
          new Date().getTimezoneOffset()
        ].join('|');
        
        let hash = 0;
        for (let i = 0; i < data.length; i++) {
          hash = ((hash << 5) - hash) + data.charCodeAt(i);
          hash = hash & hash;
        }
        
        const base36 = Math.abs(hash).toString(36).toUpperCase();
        return 'VEN-' + base36.padStart(8, '0').substring(0, 8);
      } catch (error) {
        return 'VEN-ERR-' + Date.now().toString(36).toUpperCase().substring(0, 6);
      }
    }
    
    // Verificar estado de activaci√≥n
    function checkActivationStatus() {
      const deviceId = generateDeviceId();
      const storedActivation = localStorage.getItem('app_activation_data');
      
      // Mostrar informaci√≥n en pantalla
      document.getElementById('assignedVendor').textContent = VENDEDOR_CONFIG.nombre;
      document.getElementById('deviceIdDisplay').textContent = deviceId;
      
      if (storedActivation) {
        try {
          const activationData = JSON.parse(storedActivation);
          const storedDeviceId = activationData.deviceId;
          
          // Verificar si el dispositivo coincide
          if (storedDeviceId === deviceId) {
            // ¬°Activaci√≥n v√°lida! Mostrar app
            showMainApp(activationData);
            return true;
          } else {
            // Dispositivo diferente - mostrar advertencia
            showMessage('‚ö†Ô∏è Esta app ya est√° activada en otro dispositivo.', 'error');
            document.getElementById('activationCode').disabled = true;
            document.getElementById('activationCode').placeholder = 'APP YA ACTIVADA EN OTRO DISPOSITIVO';
            return false;
          }
        } catch (error) {
          console.error('Error al leer datos de activaci√≥n:', error);
        }
      }
      
      // No hay activaci√≥n - mostrar pantalla normal
      return false;
    }
    
    // Intentar activaci√≥n
    function attemptActivation() {
      const inputCode = document.getElementById('activationCode').value.trim().toUpperCase();
      const deviceId = generateDeviceId();
      
      if (!inputCode) {
        showMessage('Por favor ingresa el c√≥digo de activaci√≥n', 'error');
        return;
      }
      
      // Verificar c√≥digo
      if (inputCode === VENDEDOR_CONFIG.codigo) {
        // Guardar datos de activaci√≥n
        const activationData = {
          vendorName: VENDEDOR_CONFIG.nombre,
          deviceId: deviceId,
          activationCode: inputCode,
          activationDate: new Date().toISOString(),
          lastAccess: new Date().toISOString()
        };
        
        localStorage.setItem('app_activation_data', JSON.stringify(activationData));
        
        // Mostrar app principal
        showMainApp(activationData);
        showMessage('‚úÖ Sistema activado correctamente', 'success');
        
      } else {
        showMessage('‚ùå C√≥digo de activaci√≥n incorrecto', 'error');
        
        // Bloquear despu√©s de 3 intentos fallidos
        const failedAttempts = parseInt(localStorage.getItem('failed_attempts') || '0') + 1;
        localStorage.setItem('failed_attempts', failedAttempts.toString());
        
        if (failedAttempts >= 3) {
          setTimeout(() => {
            showMessage('‚ö†Ô∏è Demasiados intentos fallidos. Contacta al administrador.', 'error');
            document.getElementById('activationCode').disabled = true;
            document.getElementById('activationCode').placeholder = 'BLOQUEADO TEMPORALMENTE';
          }, 1000);
        }
      }
    }
    
    // Mostrar app principal
    function showMainApp(activationData) {
      // Ocultar pantalla de activaci√≥n
      document.getElementById('activationScreen').style.display = 'none';
      
      // Mostrar contenido principal
      document.getElementById('mainAppContent').style.display = 'block';
      
      // Actualizar nombre del vendedor en la app
      document.getElementById('currentVendorName').textContent = activationData.vendorName;
      
      // Actualizar √∫ltimo acceso
      activationData.lastAccess = new Date().toISOString();
      localStorage.setItem('app_activation_data', JSON.stringify(activationData));
      
      // Inicializar sistema principal
      initializeMainApp();
    }
    
    // Mostrar mensajes
    function showMessage(text, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = text;
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 25px;
        border-radius: 10px;
        font-weight: 600;
        z-index: 10001;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      `;
      
      if (type === 'error') {
        messageDiv.style.background = '#dc2626';
        messageDiv.style.color = 'white';
      } else if (type === 'success') {
        messageDiv.style.background = '#10b981';
        messageDiv.style.color = 'white';
      } else {
        messageDiv.style.background = '#3b82f6';
        messageDiv.style.color = 'white';
      }
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }
    
    // Inicializar app principal
    function initializeMainApp() {
      // Tu c√≥digo de inicializaci√≥n original aqu√≠
      document.addEventListener('DOMContentLoaded', function() {
        // Tu c√≥digo de inicializaci√≥n original
      });
    }
    
    // Configurar evento Enter para c√≥digo de activaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      const activationCodeInput = document.getElementById('activationCode');
      if (activationCodeInput) {
        activationCodeInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            attemptActivation();
          }
        });
      }
      
      // Verificar activaci√≥n al cargar
      checkActivationStatus();
    });
    
  </script>
  
  <!-- ============================================ -->
  <!-- SCRIPT ORIGINAL DE TU APP (todo tu c√≥digo JavaScript) -->
  <!-- ============================================ -->
  <script>
    // Variables globales de tu app
    const COMMISSION_RATE = 0.009;
    let deferredPrompt = null;
    let selectedFile = null;
    let csvData = [];
    let currentProspectId = null;
    let clientFileData = [];
    let clientFileHeaders = [];
    
    // ============================================
    // SISTEMA DE NAVEGACI√ìN INTERNA
    // ============================================
    
    // Historial de navegaci√≥n
    let navigationHistory = [];
    let currentNavigationIndex = -1;
    
    // Configuraci√≥n de navegaci√≥n
    const APP_SCREENS = {
      MAIN: 'mainScreen',
      ANALYSIS: 'analysisScreen',
      CRM: 'crmScreen'
    };
    
    // Estado actual de la pantalla
    let currentScreen = APP_SCREENS.MAIN;
    
    /**
     * Inicializar sistema de navegaci√≥n
     */
    function initializeNavigation() {
      // Agregar pantalla principal al historial
      navigationHistory.push(APP_SCREENS.MAIN);
      currentNavigationIndex = 0;
      
      // Configurar evento de popstate para navegaci√≥n del navegador
      window.addEventListener('popstate', function(event) {
        event.preventDefault();
        
        // Si hay historial interno, navegar hacia atr√°s en la app
        if (currentNavigationIndex > 0) {
          goBackInApp();
        } else {
          // Mostrar mensaje de confirmaci√≥n antes de salir
          if (confirm('¬øDesea salir de la aplicaci√≥n?')) {
            // Salir de la app (solo si es PWA instalada)
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
              // En PWA, prevenir salida
              pushState();
              showToast('Presione nuevamente para salir');
            } else {
              // En navegador, permitir salida
              window.history.go(-1);
            }
          } else {
            pushState();
          }
        }
      });
      
      // Configurar estado inicial
      pushState();
    }
    
    /**
     * Agregar estado al historial del navegador
     */
    function pushState() {
      const state = { screen: currentScreen, index: currentNavigationIndex };
      window.history.pushState(state, '', '#app-' + currentScreen);
    }
    
    /**
     * Navegar a una pantalla espec√≠fica
     */
    function navigateToScreen(screenId) {
      // Guardar pantalla actual en historial
      if (currentNavigationIndex < navigationHistory.length - 1) {
        // Si estamos navegando desde un punto intermedio del historial,
        // eliminamos las pantallas posteriores
        navigationHistory = navigationHistory.slice(0, currentNavigationIndex + 1);
      }
      
      navigationHistory.push(screenId);
      currentNavigationIndex = navigationHistory.length - 1;
      currentScreen = screenId;
      
      // Actualizar interfaz
      showScreen(screenId);
      
      // Actualizar historial del navegador
      pushState();
    }
    
    /**
     * Navegar hacia atr√°s dentro de la app
     */
    function goBackInApp() {
      if (currentNavigationIndex > 0) {
        currentNavigationIndex--;
        const previousScreen = navigationHistory[currentNavigationIndex];
        currentScreen = previousScreen;
        
        // Actualizar interfaz
        showScreen(previousScreen);
        
        // Actualizar historial del navegador
        pushState();
        return true;
      }
      return false;
    }
    
    /**
     * Mostrar pantalla espec√≠fica
     */
    function showScreen(screenId) {
      // Ocultar todas las pantallas
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('analysisScreen').classList.remove('active');
      document.getElementById('crmScreen').classList.remove('active');
      
      // Mostrar pantalla solicitada
      if (screenId === APP_SCREENS.MAIN) {
        document.getElementById('mainScreen').style.display = 'block';
        refreshUI();
      } else if (screenId === APP_SCREENS.ANALYSIS) {
        document.getElementById('analysisScreen').classList.add('active');
        calculateAndDisplayKPIs();
      } else if (screenId === APP_SCREENS.CRM) {
        document.getElementById('crmScreen').classList.add('active');
        loadProspects();
        updateProspectStats();
        actualizarNombreVendedor();
      }
      
      currentScreen = screenId;
    }
    
    /**
     * Manejar clic en bot√≥n atr√°s del dispositivo
     */
    function handleBackButton() {
      // Primero verificar si hay modales abiertos
      const openModals = document.querySelectorAll('.modal.active');
      if (openModals.length > 0) {
        // Cerrar el √∫ltimo modal abierto
        const lastModal = openModals[openModals.length - 1];
        lastModal.classList.remove('active');
        return true;
      }
      
      // Si no hay modales, navegar hacia atr√°s en la app
      return goBackInApp();
    }
    
    // ============================================
    // FUNCIONES CR√çTICAS CORREGIDAS - LOGICA DE CICLOS
    // ============================================

    /**
     * Obtiene el ciclo correcto para una fecha espec√≠fica
     * BASADO EN: fecha_venta <= fecha_cierre -> Ciclo 1
     *            fecha_venta > fecha_cierre -> Ciclo 2
     */
    function getCycleFromDate(dateString) {
      const date = new Date(dateString);
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      
      if (!lastClose) {
        return 'C1'; // Primer ciclo (no hay cierres anteriores)
      }
      
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999); // Fin del d√≠a de cierre
      
      // CORRECCI√ìN: Si la fecha de venta es <= fecha_cierre, va en C1
      // Si es > fecha_cierre, va en C2
      if (date <= lastCloseDate) {
        return 'C1';
      } else {
        return 'C2';
      }
    }

    /**
     * Determina el ciclo actual basado en la fecha de hoy vs √∫ltimo cierre
     */
    function getCurrentCycle() {
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      if (!lastClose) return 'C1';
      
      const today = new Date();
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999);
      
      return today <= lastCloseDate ? 'C1' : 'C2';
    }

    /**
     * Obtiene TODAS las ventas del ciclo actual (posteriores al √∫ltimo cierre)
     * SIN LIMITE - TODAS LAS VENTAS
     */
    function getCurrentCycleSales() {
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      const permanentSales = getStorage('ventas_permanentes');
      
      if (!lastClose) {
        // Si no hay cierre previo, todas las ventas est√°n en C1
        return permanentSales;
      }
      
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999);
      
      // Solo ventas POSTERIORES al √∫ltimo cierre
      return permanentSales.filter(sale => {
        const saleDate = new Date(sale.date_iso);
        return saleDate > lastCloseDate;
      });
    }

    /**
     * Obtiene las ventas del ciclo anterior (hasta el √∫ltimo cierre inclusive)
     */
    function getPreviousCycleSales() {
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      const permanentSales = getStorage('ventas_permanentes');
      
      if (!lastClose) {
        return []; // No hay ciclo anterior
      }
      
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999);
      
      // Ventas hasta el d√≠a de cierre inclusive
      return permanentSales.filter(sale => {
        const saleDate = new Date(sale.date_iso);
        return saleDate <= lastCloseDate;
      });
    }

    /**
     * Obtiene el resumen del √∫ltimo ciclo cerrado desde el historial
     */
    function getLastClosedCycleSummary() {
      const cycleHistory = getStorage('historial_ciclos') || [];
      
      if (cycleHistory.length === 0) {
        return null;
      }
      
      // Ordenar por fecha de cierre (m√°s reciente primero)
      const sortedHistory = cycleHistory.sort((a, b) => 
        new Date(b.fecha_cierre) - new Date(a.fecha_cierre)
      );
      
      // Devolver el √∫ltimo ciclo cerrado
      return sortedHistory[0];
    }

    // ============================================
    // FUNCIONES AUXILIARES GENERALES
    // ============================================

    function showMainScreen() {
      navigateToScreen(APP_SCREENS.MAIN);
    }

    function showAnalysisScreen() {
      navigateToScreen(APP_SCREENS.ANALYSIS);
    }

    function showCRMScreen() {
      navigateToScreen(APP_SCREENS.CRM);
    }

    function getStorage(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('Error reading storage:', e);
        return [];
      }
    }

    function setStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) {
        console.error('Error saving storage:', e);
        alert('Error al guardar datos. Verifica el espacio disponible.');
        return false;
      }
    }

    function formatCLP(amount) {
      const num = Math.round(parseFloat(amount) || 0);
      const sign = num < 0 ? '-' : '';
      const abs = Math.abs(num);
      return `${sign}$ ${abs.toLocaleString('es-CL')}`;
    }

    function getCurrentDate() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    function parseAmount(str) {
      if (!str) throw new Error('Introduce un n√∫mero v√°lido');
      const cleaned = str.replace(/[^0-9]/g, '');
      if (!cleaned) throw new Error('Introduce un n√∫mero v√°lido');
      return parseFloat(cleaned);
    }

    /**
     * Formato de fecha/hora legible: "DD/MM/YYYY HH:MM"
     */
    function formatDateTimeLegible(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function formatDateForExcel(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${day}/${month}/${year}`;
    }

    function formatDateTimeForExcel(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // ============================================
    // FUNCIONES DE VENTAS Y COMISIONES - RENDERIZACI√ìN MEJORADA
    // ============================================

    function addSale() {
      const input = document.getElementById('amountInput');
      const amountText = input.value;
      
      try {
        const amt = parseAmount(amountText);
        const net = Math.round(amt / 1.19);
        const commission = Math.round(net * COMMISSION_RATE);
        
        const sale = {
          amount_with_vat: Math.round(amt),
          net_without_vat: net,
          commission: commission,
          timestamp: new Date().toISOString(),
          date_iso: getCurrentDate(),
          month_id: getCurrentDate().substring(0, 7),
          cycle_id: getCycleFromDate(getCurrentDate())
        };

        // Agregar a ventas permanentes
        const permanentSales = getStorage('ventas_permanentes');
        permanentSales.push(sale);
        setStorage('ventas_permanentes', permanentSales);

        // Agregar a ciclo actual si corresponde
        if (getCurrentCycle() === sale.cycle_id) {
          const salesCycle = getStorage('ventas_ciclo');
          salesCycle.push(sale);
          setStorage('ventas_ciclo', salesCycle);
        }

        // Agregar a ventas del d√≠a
        const salesDay = getStorage('ventas_dia');
        salesDay.push(sale);
        setStorage('ventas_dia', salesDay);

        if (input.value) {
          input.value = '';
          refreshUI();
          showToast('‚úì Venta agregada correctamente');
        }
      } catch (e) {
        alert(e.message);
      }
    }

    function deleteLastSale() {
      const salesDay = getStorage('ventas_dia');
      
      if (salesDay.length === 0) {
        alert('No hay ventas para eliminar');
        return;
      }
      
      const lastSale = salesDay[salesDay.length - 1];
      const lastAmount = formatCLP(lastSale.amount_with_vat);
      
      if (!confirm(`¬øEliminar la √∫ltima venta de ${lastAmount}?`)) {
        return;
      }
      
      // Eliminar de ventas permanentes
      const permanentSales = getStorage('ventas_permanentes');
      const permIndex = permanentSales.findIndex(s => 
        s.timestamp === lastSale.timestamp && 
        s.amount_with_vat === lastSale.amount_with_vat
      );
      if (permIndex !== -1) {
        permanentSales.splice(permIndex, 1);
        setStorage('ventas_permanentes', permanentSales);
      }
      
      // Eliminar de ventas del d√≠a
      salesDay.pop();
      setStorage('ventas_dia', salesDay);
      
      // Eliminar de ciclo si corresponde
      const salesCycle = getStorage('ventas_ciclo');
      const cycleIndex = salesCycle.findIndex(s => 
        s.timestamp === lastSale.timestamp && 
        s.amount_with_vat === lastSale.amount_with_vat
      );
      if (cycleIndex !== -1) {
        salesCycle.splice(cycleIndex, 1);
        setStorage('ventas_ciclo', salesCycle);
      }
      
      refreshUI();
      showToast('‚úì √öltima venta eliminada');
    }

    /**
     * REFRESH UI MEJORADO - MUESTRA TODAS LAS VENTAS
     */
    function refreshUI() {
      const salesDay = getStorage('ventas_dia');
      const currentCycleSales = getCurrentCycleSales(); // TODAS las ventas del ciclo
      
      const dayWithVat = Math.round(salesDay.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const dayWithoutVat = Math.round(salesDay.reduce((sum, s) => sum + s.net_without_vat, 0));
      const dayCommission = Math.round(salesDay.reduce((sum, s) => sum + s.commission, 0));
      
      const cycleWithVat = Math.round(currentCycleSales.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const cycleWithoutVat = Math.round(currentCycleSales.reduce((sum, s) => sum + s.net_without_vat, 0));
      const cycleCommission = Math.round(currentCycleSales.reduce((sum, s) => sum + s.commission, 0));
      
      document.getElementById('dayWithVat').textContent = formatCLP(dayWithVat);
      document.getElementById('dayWithoutVat').textContent = formatCLP(dayWithoutVat);
      document.getElementById('dayCommission').textContent = formatCLP(dayCommission);
      document.getElementById('cycleWithVat').textContent = formatCLP(cycleWithVat);
      document.getElementById('cycleWithoutVat').textContent = formatCLP(cycleWithoutVat);
      document.getElementById('cycleCommission').textContent = formatCLP(cycleCommission);
      
      // RENDERIZACI√ìN MEJORADA - TODAS LAS VENTAS, NO SOLO 20
      renderSalesList('salesDay', salesDay.slice().reverse()); // Mostrar TODAS del d√≠a
      renderSalesList('salesCycle', currentCycleSales.slice().reverse()); // Mostrar TODAS del ciclo
      
      // RENDERIZAR HISTORIAL COMPLETO
      renderAllSalesHistory();
      
      updateCycleSummary();
    }

    /**
     * RENDERIZACI√ìN MEJORADA - MUESTRA FECHA/HORA LEGIBLE
     */
    function renderSalesList(elementId, sales) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      
      if (sales.length === 0) {
        return; // El :empty CSS se encarga del mensaje
      }
      
      sales.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'sale-item';
        
        // Formato legible: "DD/MM/YYYY HH:MM"
        const dateTime = formatDateTimeLegible(s.timestamp);
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--accent); margin-bottom: 2px;">
                ${formatCLP(s.amount_with_vat)}
              </div>
              <div style="font-size: 11px; color: var(--muted);">
                üìÖ ${dateTime}
              </div>
            </div>
            <div style="text-align: right; min-width: 100px;">
              <div style="font-size: 12px; color: var(--text);">
                Neto: ${formatCLP(s.net_without_vat)}
              </div>
              <div style="font-size: 12px; color: var(--accent); font-weight: 600;">
                Com: ${formatCLP(s.commission)}
              </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    /**
     * NUEVA FUNCI√ìN: RENDERIZAR HISTORIAL COMPLETO DE VENTAS
     * Muestra TODAS las ventas permanentes ordenadas descendente
     */
    function renderAllSalesHistory() {
      const permanentSales = getStorage('ventas_permanentes');
      const container = document.getElementById('salesHistory');
      container.innerHTML = '';
      
      if (permanentSales.length === 0) {
        return; // El :empty CSS se encarga del mensaje
      }
      
      // Ordenar por fecha descendente (m√°s reciente primero)
      const sortedSales = [...permanentSales].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      sortedSales.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'sale-item';
        
        // Formato legible: "DD/MM/YYYY HH:MM"
        const dateTime = formatDateTimeLegible(s.timestamp);
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--accent); margin-bottom: 2px;">
                ${formatCLP(s.amount_with_vat)}
              </div>
              <div style="font-size: 11px; color: var(--muted);">
                üìÖ ${dateTime} | üìÜ ${s.date_iso} | üîÑ ${s.cycle_id || getCycleFromDate(s.date_iso)}
              </div>
            </div>
            <div style="text-align: right; min-width: 100px;">
              <div style="font-size: 12px; color: var(--text);">
                Neto: ${formatCLP(s.net_without_vat)}
              </div>
              <div style="font-size: 12px; color: var(--accent); font-weight: 600;">
                Com: ${formatCLP(s.commission)}
              </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // ============================================
    // FUNCIONES DE CIERRE DE CICLO (CORREGIDAS)
    // ============================================

    function showCloseCycleModal() {
      showModal('closeCycleModal');
      updateCycleSummary();
      
      const cycleCloseDate = document.getElementById('cycleCloseDate');
      if (cycleCloseDate) {
        const today = new Date().toISOString().split('T')[0];
        cycleCloseDate.value = today;
      }
    }

    function updateCycleSummary() {
      const currentCycleSales = getCurrentCycleSales();
      
      const cycleWithVat = Math.round(currentCycleSales.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const cycleWithoutVat = Math.round(currentCycleSales.reduce((sum, s) => sum + s.net_without_vat, 0));
      const cycleCommission = Math.round(currentCycleSales.reduce((sum, s) => sum + s.commission, 0));
      const cycleCount = currentCycleSales.length;
      
      document.getElementById('cycleSummaryWithVat').textContent = formatCLP(cycleWithVat);
      document.getElementById('cycleSummaryWithoutVat').textContent = formatCLP(cycleWithoutVat);
      document.getElementById('cycleSummaryCommission').textContent = formatCLP(cycleCommission);
      document.getElementById('cycleSummaryCount').textContent = cycleCount;
    }

    function confirmCloseCycle() {
      const cycleDate = document.getElementById('cycleCloseDate').value;
      if (!cycleDate) {
        alert('Por favor selecciona una fecha de cierre');
        return;
      }
      
      // Guardar fecha de cierre
      localStorage.setItem('ultimo_cierre_ciclo', cycleDate);
      
      // Obtener ventas del ciclo que se est√° cerrando (hasta la fecha de cierre)
      const cycleSales = getCurrentCycleSales().filter(sale => {
        const saleDate = new Date(sale.date_iso);
        const closeDate = new Date(cycleDate);
        closeDate.setHours(23, 59, 59, 999);
        return saleDate <= closeDate;
      });
      
      // Guardar historial del ciclo
      const cycleHistory = getStorage('historial_ciclos') || [];
      const totalWithVat = Math.round(cycleSales.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const totalWithoutVat = Math.round(cycleSales.reduce((sum, s) => sum + s.net_without_vat, 0));
      const totalCommission = Math.round(cycleSales.reduce((sum, s) => sum + s.commission, 0));
      
      cycleHistory.push({
        fecha_cierre: cycleDate,
        ciclo: getCurrentCycle(),
        ventas_count: cycleSales.length,
        total_with_vat: totalWithVat,
        total_without_vat: totalWithoutVat,
        comision_total: totalCommission
      });
      
      setStorage('historial_ciclos', cycleHistory);
      
      // Limpiar ventas del ciclo actual (se recrear√°n con getCurrentCycleSales)
      setStorage('ventas_ciclo', []);
      
      // Vaciar ventas del d√≠a
      setStorage('ventas_dia', []);
      
      hideModal('closeCycleModal');
      refreshUI();
      showToast('‚úì Ciclo cerrado correctamente');
    }

    function closeDay() {
      setStorage('ventas_dia', []);
      refreshUI();
      showToast('‚úì D√≠a cerrado. Ventas del d√≠a vaciadas.');
    }

    // ============================================
    // FUNCIONES DE IMPORTACI√ìN CSV SIN DETECCI√ìN DE DUPLICADOS
    // ============================================

    function showUploadModal() {
      showModal('uploadModal');
      resetUploadForm();
    }

    function resetUploadForm() {
      document.getElementById('csvFile').value = '';
      document.getElementById('fileName').textContent = 'No se ha seleccionado ning√∫n archivo';
      document.getElementById('filePreview').style.display = 'none';
      document.getElementById('uploadStats').style.display = 'none';
      document.getElementById('processBtn').disabled = true;
      selectedFile = null;
      csvData = [];
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) {
        resetUploadForm();
        return;
      }

      selectedFile = file;
      document.getElementById('fileName').textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
      document.getElementById('processBtn').disabled = false;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          csvData = parseCSV(content);
          
          if (csvData.length === 0) {
            alert('El archivo CSV est√° vac√≠o o no tiene el formato correcto.');
            resetUploadForm();
            return;
          }

          showPreview(csvData);
          showUploadStats(csvData);
        } catch (error) {
          alert('Error al leer el archivo CSV: ' + error.message);
          resetUploadForm();
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    function parseCSV(content) {
      const lines = content.split('\n').filter(line => line.trim() !== '');
      
      if (lines.length === 0) {
        return [];
      }

      const firstLine = lines[0].toLowerCase();
      const hasHeader = firstLine.includes('fecha/hora') || firstLine.includes('monto') || firstLine.includes('comisi√≥n');
      
      const startIndex = hasHeader ? 1 : 0;
      const data = [];

      for (let i = startIndex; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const cells = [];
        let inQuotes = false;
        let currentCell = '';
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cells.push(currentCell);
            currentCell = '';
          } else {
            currentCell += char;
          }
        }
        cells.push(currentCell);
        
        const cleanCells = cells.map(cell => cell.replace(/"/g, '').trim());
        
        if (cleanCells.length >= 6) {
          const [fechaHoraStr, montoConIVARaw, netoSinIVARaw, comisionRaw, fechaStr, mesStr] = cleanCells;
          
          const timestamp = parseDateString(fechaHoraStr);
          const dateIso = parseDateOnly(fechaStr);
          const monthId = mesStr;
          
          const montoConIVA = Math.round(parseNumber(montoConIVARaw));
          const netoSinIVA = Math.round(parseNumber(netoSinIVARaw));
          const comision = Math.round(parseNumber(comisionRaw));
          
          if (timestamp && !isNaN(montoConIVA) && !isNaN(netoSinIVA) && !isNaN(comision) && dateIso && monthId) {
            data.push({
              fecha_hora: fechaHoraStr,
              amount_with_vat: montoConIVA,
              net_without_vat: netoSinIVA,
              commission: comision,
              fecha: fechaStr,
              mes: mesStr,
              timestamp: timestamp.toISOString(),
              date_iso: dateIso,
              month_id: monthId
            });
          }
        }
      }
      
      return data;
    }

    function parseDateString(dateStr) {
      const parts = dateStr.split(' ');
      if (parts.length !== 2) return new Date();
      
      const datePart = parts[0];
      const timePart = parts[1];
      
      const dateParts = datePart.split('/');
      if (dateParts.length !== 3) return new Date();
      
      const day = parseInt(dateParts[0]);
      const month = parseInt(dateParts[1]) - 1;
      const year = 2000 + parseInt(dateParts[2]);
      
      const timeParts = timePart.split(':');
      const hours = timeParts.length >= 1 ? parseInt(timeParts[0]) : 0;
      const minutes = timeParts.length >= 2 ? parseInt(timeParts[1]) : 0;
      
      return new Date(year, month, day, hours, minutes);
    }

    function parseDateOnly(dateStr) {
      const parts = dateStr.split('/');
      if (parts.length !== 3) return '';
      
      const day = parts[0].padStart(2, '0');
      const month = parts[1].padStart(2, '0');
      const year = '20' + parts[2];
      
      return `${year}-${month}-${day}`;
    }

    function parseNumber(numStr) {
      const clean = numStr.replace(/\./g, '').replace(',', '.');
      return parseFloat(clean) || 0;
    }

    function showPreview(data) {
      const previewBody = document.getElementById('previewBody');
      previewBody.innerHTML = '';
      
      const previewCount = Math.min(5, data.length);
      
      for (let i = 0; i < previewCount; i++) {
        const row = data[i];
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${row.fecha_hora || ''}</td>
          <td>${formatCLP(row.amount_with_vat)}</td>
          <td>${formatCLP(row.net_without_vat)}</td>
          <td>${formatCLP(row.commission)}</td>
          <td>${row.fecha || ''}</td>
          <td>${row.mes || ''}</td>
        `;
        
        previewBody.appendChild(tr);
      }
      
      document.getElementById('filePreview').style.display = 'block';
    }

    function showUploadStats(data) {
      const totalRecords = data.length;
      
      document.getElementById('totalRecords').textContent = totalRecords;
      document.getElementById('newRecords').textContent = totalRecords;
      document.getElementById('importRecords').textContent = totalRecords;
      
      document.getElementById('uploadStats').style.display = 'block';
    }

    function processCSVFile() {
      if (!selectedFile || csvData.length === 0) {
        alert('No hay archivo para procesar.');
        return;
      }

      const permanentSales = getStorage('ventas_permanentes');
      const today = getCurrentDate();
      const currentCycle = getCurrentCycle();
      
      let addedToPermanent = 0;
      let addedToCycle = 0;
      let addedToDay = 0;

      csvData.forEach(row => {
        // SIN DETECCI√ìN DE DUPLICADOS - TODAS LAS VENTAS SE IMPORTAN
        const cycleId = getCycleFromDate(row.date_iso);
        
        const sale = {
          amount_with_vat: row.amount_with_vat,
          net_without_vat: row.net_without_vat,
          commission: row.commission,
          timestamp: row.timestamp,
          date_iso: row.date_iso,
          month_id: row.month_id,
          cycle_id: cycleId
        };

        permanentSales.push(sale);
        addedToPermanent++;

        // Agregar al ciclo actual si corresponde
        if (cycleId === currentCycle) {
          const salesCycle = getStorage('ventas_ciclo');
          salesCycle.push(sale);
          setStorage('ventas_ciclo', salesCycle);
          addedToCycle++;
        }

        // Agregar a ventas del d√≠a si corresponde
        if (row.date_iso === today) {
          const salesDay = getStorage('ventas_dia');
          salesDay.push(sale);
          setStorage('ventas_dia', salesDay);
          addedToDay++;
        }
      });

      setStorage('ventas_permanentes', permanentSales);

      let message = `‚úÖ Archivo procesado correctamente (sin verificaci√≥n de duplicados):\n\n`;
      message += `‚Ä¢ Registros importados: ${csvData.length}\n`;
      
      if (addedToCycle > 0) {
        message += `‚Ä¢ Agregados al ciclo actual: ${addedToCycle}\n`;
      }
      
      if (addedToDay > 0) {
        message += `‚Ä¢ Agregados al d√≠a actual: ${addedToDay}\n`;
      }

      alert(message);
      hideModal('uploadModal');
      refreshUI();
      showToast(`‚úÖ ${csvData.length} ventas importadas (sin verificar duplicados)`);
    }

    // ============================================
    // FUNCIONES DE DESINSTALACI√ìN COMPLETA
    // ============================================

    function showUninstallModal() {
      showModal('uninstallModal');
      document.getElementById('uninstallConfirm').value = '';
      document.getElementById('confirmUninstallBtn').disabled = true;
    }

    function checkUninstallConfirmation() {
      const input = document.getElementById('uninstallConfirm');
      const confirmBtn = document.getElementById('confirmUninstallBtn');
      confirmBtn.disabled = input.value.toUpperCase() !== 'DESINSTALAR';
    }

    function performCompleteUninstall() {
      // 1. Eliminar TODOS los datos de localStorage
      const keysToRemove = [
        'ventas_dia', 'ventas_ciclo', 'ventas_permanentes', 
        'prospectos', 'ultimo_cierre_ciclo', 'nombre_vendedor',
        'historial_ciclos'
      ];
      
      keysToRemove.forEach(key => {
        localStorage.removeItem(key);
      });
      
      // 2. Eliminar todos los datos de IndexedDB si existe
      if (window.indexedDB) {
        indexedDB.databases().then(databases => {
          databases.forEach(db => {
            indexedDB.deleteDatabase(db.name);
          });
        }).catch(console.log);
      }
      
      // 3. Eliminar cache de Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.unregister();
          });
        });
        
        // Eliminar cache
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
              caches.delete(cacheName);
            });
          });
        }
      }
      
      // 4. Mostrar mensaje final
      hideModal('uninstallModal');
      
      setTimeout(() => {
        alert('‚úÖ APP DESINSTALADA COMPLETAMENTE\n\n' +
              'Todos los datos han sido eliminados.\n' +
              'La aplicaci√≥n ya no funcionar√° en este dispositivo.\n' +
              'Para volver a usar el sistema, deber√°s reinstalarla manualmente.');
        
        // 5. Intentar eliminar la app instalada (si es PWA)
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
          // En algunos dispositivos se puede sugerir desinstalaci√≥n
          if (navigator.app && navigator.app.uninstallApp) {
            navigator.app.uninstallApp();
          } else {
            // Mostrar instrucciones para desinstalar manualmente
            alert('Para completar la desinstalaci√≥n:\n' +
                  '1. Ve a la configuraci√≥n de tu dispositivo\n' +
                  '2. Busca "Aplicaciones" o "Apps"\n' +
                  '3. Encuentra "Sistema de Comisiones"\n' +
                  '4. Selecciona "Desinstalar"\n\n' +
                  'Los datos ya han sido eliminados.');
          }
        }
        
        // 6. Recargar p√°gina para limpiar estado
        setTimeout(() => {
          window.location.href = 'about:blank';
          window.close();
        }, 2000);
      }, 500);
    }

    // ============================================
    // FUNCIONES DE KPI Y AN√ÅLISIS
    // ============================================

    function calculateAndDisplayKPIs() {
      const permanentSales = getStorage('ventas_permanentes');
      const today = getCurrentDate();
      
      const startOfWeek = getStartOfWeek();
      
      const daySales = permanentSales.filter(s => s.date_iso === today);
      const currentCycleSales = getCurrentCycleSales();
      const previousCycleSales = getPreviousCycleSales();
      
      // Ventas del d√≠a
      const dayTotal = Math.round(daySales.reduce((sum, s) => sum + s.net_without_vat, 0));
      const dayCount = daySales.length;
      const dayAverage = dayCount > 0 ? Math.round(dayTotal / dayCount) : 0;
      const dayCommission = Math.round(daySales.reduce((sum, s) => sum + s.commission, 0));
      
      // CICLO ACTUAL
      const currentCycleTotal = Math.round(currentCycleSales.reduce((sum, s) => sum + s.net_without_vat, 0));
      const currentCycleCount = currentCycleSales.length;
      const currentCycleAverage = currentCycleCount > 0 ? Math.round(currentCycleTotal / currentCycleCount) : 0;
      const currentCycleCommission = Math.round(currentCycleSales.reduce((sum, s) => sum + s.commission, 0));
      
      // CICLO ANTERIOR CERRADO
      const previousCycleTotal = Math.round(previousCycleSales.reduce((sum, s) => sum + s.net_without_vat, 0));
      const previousCycleCount = previousCycleSales.length;
      const previousCycleAverage = previousCycleCount > 0 ? Math.round(previousCycleTotal / previousCycleCount) : 0;
      const previousCycleCommission = Math.round(previousCycleSales.reduce((sum, s) => sum + s.commission, 0));
      
      // Actualizar KPI del d√≠a
      document.getElementById('kpiDayTotal').textContent = formatCLP(dayTotal);
      document.getElementById('kpiDayCount').textContent = dayCount;
      document.getElementById('kpiDayAverage').textContent = formatCLP(dayAverage);
      document.getElementById('kpiDayCommission').textContent = formatCLP(dayCommission);
      
      // Actualizar KPI del ciclo actual
      document.getElementById('kpiCurrentCycleTotal').textContent = formatCLP(currentCycleTotal);
      document.getElementById('kpiCurrentCycleCount').textContent = currentCycleCount;
      document.getElementById('kpiCurrentCycleAverage').textContent = formatCLP(currentCycleAverage);
      document.getElementById('kpiCurrentCycleCommission').textContent = formatCLP(currentCycleCommission);
      
      // Actualizar KPI del ciclo anterior
      document.getElementById('kpiPreviousCycleTotal').textContent = formatCLP(previousCycleTotal);
      document.getElementById('kpiPreviousCycleCount').textContent = previousCycleCount;
      document.getElementById('kpiPreviousCycleAverage').textContent = formatCLP(previousCycleAverage);
      document.getElementById('kpiPreviousCycleCommission').textContent = formatCLP(previousCycleCommission);
      
      // Mostrar informaci√≥n adicional sobre el ciclo anterior
      const lastCloseDate = localStorage.getItem('ultimo_cierre_ciclo');
      if (lastCloseDate && previousCycleCount > 0) {
        console.log(`Ciclo anterior cerrado el: ${lastCloseDate}`);
      }
      
      // C√°lculo comparativo
      const totalDifference = currentCycleTotal - previousCycleTotal;
      const countDifference = currentCycleCount - previousCycleCount;
      const commissionDifference = currentCycleCommission - previousCycleCommission;

      // Aplicar formato con signo
      function formatWithSign(value) {
        const sign = value >= 0 ? '+' : '';
        return sign + formatCLP(value);
      }

      document.getElementById('comparisonTotal').textContent = formatWithSign(totalDifference);
      document.getElementById('comparisonCount').textContent = countDifference >= 0 ? '+' + countDifference : countDifference;
      document.getElementById('comparisonCommission').textContent = formatWithSign(commissionDifference);

      // Aplicar colores seg√∫n la diferencia
      const comparisonElements = ['comparisonTotal', 'comparisonCount', 'comparisonCommission'];
      comparisonElements.forEach(id => {
        const element = document.getElementById(id);
        const text = element.textContent;
        if (text.startsWith('+')) {
          element.style.color = '#10b981'; // Verde para positivo
        } else if (text.startsWith('-')) {
          element.style.color = '#dc2626'; // Rojo para negativo
        }
      });
    }

    function getStartOfWeek() {
      const now = new Date();
      const day = now.getDay();
      const diff = day === 0 ? 6 : day - 1;
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - diff);
      startOfWeek.setHours(0, 0, 0, 0);
      return startOfWeek.toISOString().split('T')[0];
    }

    function isDateInWeek(dateString, startOfWeek) {
      const date = new Date(dateString);
      const start = new Date(startOfWeek);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      
      return date >= start && date <= end;
    }

    // ============================================
    // FUNCIONES CRM
    // ============================================

    function getProspectsStorage() {
      try {
        const data = localStorage.getItem('prospectos');
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('Error leyendo prospectos:', e);
        return [];
      }
    }

    function setProspectsStorage(prospects) {
      try {
        localStorage.setItem('prospectos', JSON.stringify(prospects));
        return true;
      } catch (e) {
        console.error('Error guardando prospectos:', e);
        alert('Error al guardar. Verifica el espacio disponible.');
        return false;
      }
    }

    function generateProspectId() {
      return 'prospect_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showAddProspectModal() {
      document.getElementById('prospectName').value = '';
      document.getElementById('prospectPhone').value = '';
      document.getElementById('prospectProduct').value = '';
      document.getElementById('prospectStatus').value = 'Falta contactar';
      document.getElementById('prospectObservation').value = '';
      document.getElementById('prospectTagTrabajo').checked = false;
      document.getElementById('prospectTagCotizacion').checked = false;
      showModal('addProspectModal');
    }

    function saveProspect() {
      const name = document.getElementById('prospectName').value.trim();
      const phone = document.getElementById('prospectPhone').value.trim();
      const product = document.getElementById('prospectProduct').value.trim();
      const status = document.getElementById('prospectStatus').value;
      const observation = document.getElementById('prospectObservation').value.trim();
      
      const etiquetas = [];
      if (document.getElementById('prospectTagTrabajo').checked) {
        etiquetas.push('TRABAJO EN CURSO');
      }
      if (document.getElementById('prospectTagCotizacion').checked) {
        etiquetas.push('COTIZACI√ìN');
      }
      
      if (!name || !phone || !product) {
        alert('Por favor completa los campos obligatorios: Nombre, Tel√©fono y Producto.');
        return;
      }
      
      const prospects = getProspectsStorage();
      
      const existingProspect = prospects.find(p => p.telefono === phone);
      if (existingProspect) {
        alert('Ya existe un prospecto con este n√∫mero de tel√©fono.');
        return;
      }
      
      const newProspect = {
        id: generateProspectId(),
        nombre: name,
        telefono: phone,
        producto: product,
        estado: status,
        etiquetas: etiquetas,
        observaciones: [],
        fechaCreacion: new Date().toISOString(),
        fechaActualizacion: new Date().toISOString()
      };
      
      if (observation) {
        newProspect.observaciones.push({
          fecha: new Date().toISOString(),
          texto: observation
        });
      }
      
      prospects.push(newProspect);
      setProspectsStorage(prospects);
      
      hideModal('addProspectModal');
      loadProspects();
      updateProspectStats();
      showToast('‚úÖ Prospecto guardado correctamente');
    }

    function loadProspects() {
      const prospects = getProspectsStorage();
      const container = document.getElementById('prospectList');
      
      if (prospects.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted); font-style: italic;">No hay prospectos registrados.</div>';
        return;
      }
      
      updateProductFilter(prospects);
      
      const searchTerm = document.getElementById('searchProspect')?.value.toLowerCase() || '';
      const filterStatus = document.getElementById('filterStatus')?.value || '';
      const filterProduct = document.getElementById('filterProduct')?.value || '';
      
      let filteredProspects = prospects;
      
      if (searchTerm) {
        filteredProspects = filteredProspects.filter(p => 
          p.nombre.toLowerCase().includes(searchTerm) || 
          p.telefono.includes(searchTerm)
        );
      }
      
      if (filterStatus) {
        filteredProspects = filteredProspects.filter(p => p.estado === filterStatus);
      }
      
      if (filterProduct) {
        filteredProspects = filteredProspects.filter(p => p.producto === filterProduct);
      }
      
      container.innerHTML = '';
      
      filteredProspects.forEach(prospect => {
        const div = document.createElement('div');
        div.className = 'prospect-item';
        div.onclick = () => showProspectDetail(prospect.id);
        
        let statusClass = 'status-not-contacted';
        if (prospect.estado === 'Contactado por WhatsApp') {
          statusClass = 'status-whatsapp';
        } else if (prospect.estado === 'Contactado por llamada') {
          statusClass = 'status-call';
        } else if (prospect.estado === 'Contactado por WhatsApp y Llamada') {
          statusClass = 'status-both';
        } else if (prospect.estado === 'Falta contactar') {
          statusClass = 'status-not-contacted';
        }
        
        const lastObservation = prospect.observaciones.length > 0 
          ? prospect.observaciones[prospect.observaciones.length - 1].texto 
          : 'Sin observaciones';
        
        let etiquetasHTML = '';
        if (prospect.etiquetas && prospect.etiquetas.length > 0) {
          etiquetasHTML = `<span>üè∑Ô∏è ${prospect.etiquetas.join(', ')}</span>`;
        }
        
        div.innerHTML = `
          <div class="prospect-info">
            <div class="prospect-name">${prospect.nombre}</div>
            <div class="prospect-details">
              <span>üìû ${prospect.telefono}</span>
              <span>üì¶ ${prospect.producto}</span>
              <span class="prospect-status ${statusClass}">${prospect.estado}</span>
              ${etiquetasHTML}
              <span>üìù ${lastObservation.substring(0, 30)}${lastObservation.length > 30 ? '...' : ''}</span>
            </div>
          </div>
          <div style="color: var(--muted); font-size: 12px;">üëÅÔ∏è Ver</div>
        `;
        container.appendChild(div);
      });
    }

    function updateProductFilter(prospects) {
      const filterProduct = document.getElementById('filterProduct');
      if (!filterProduct) return;
      
      const currentValue = filterProduct.value;
      const products = [...new Set(prospects.map(p => p.producto))].filter(p => p);
      
      filterProduct.innerHTML = '<option value="">Todos los productos</option>';
      products.forEach(product => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        filterProduct.appendChild(option);
      });
      
      if (products.includes(currentValue)) {
        filterProduct.value = currentValue;
      }
    }

    function filterProspects() {
      loadProspects();
      updateProspectStats();
    }

    function resetFilters() {
      document.getElementById('searchProspect').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterProduct').value = '';
      loadProspects();
      updateProspectStats();
    }

    function updateProspectStats() {
      const prospects = getProspectsStorage();
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      const total = prospects.length;
      const pending = prospects.filter(p => p.estado === 'Falta contactar').length;
      const contacted = prospects.filter(p => p.estado !== 'Falta contactar').length;
      const recent = prospects.filter(p => new Date(p.fechaCreacion) > sevenDaysAgo).length;
      
      document.getElementById('totalProspects').textContent = total;
      document.getElementById('pendingProspects').textContent = pending;
      document.getElementById('contactedProspects').textContent = contacted;
      document.getElementById('recentProspects').textContent = recent;
    }

    function showProspectDetail(id) {
      const prospects = getProspectsStorage();
      const prospect = prospects.find(p => p.id === id);
      
      if (!prospect) {
        alert('Prospecto no encontrado.');
        return;
      }
      
      currentProspectId = id;
      
      document.getElementById('detailProspectName').textContent = prospect.nombre;
      document.getElementById('detailProspectPhone').textContent = prospect.telefono;
      document.getElementById('detailProspectProduct').textContent = prospect.producto;
      document.getElementById('detailProspectStatus').value = prospect.estado;
      document.getElementById('detailProspectNextContact').value = prospect.proximoContacto || '';
      
      const tagsContainer = document.getElementById('detailProspectTags');
      tagsContainer.innerHTML = '';
      if (prospect.etiquetas && prospect.etiquetas.length > 0) {
        prospect.etiquetas.forEach(tag => {
          const span = document.createElement('span');
          span.className = 'tag active';
          span.textContent = tag;
          span.style.marginRight = '4px';
          span.style.marginBottom = '4px';
          tagsContainer.appendChild(span);
        });
      }
      
      const obsContainer = document.getElementById('detailProspectObservations');
      obsContainer.innerHTML = '';
      
      if (prospect.observaciones.length === 0) {
        obsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted); font-style: italic;">No hay observaciones registradas.</div>';
      } else {
        [...prospect.observaciones].reverse().forEach(obs => {
          const div = document.createElement('div');
          div.className = 'observation-item';
          const date = new Date(obs.fecha);
          div.innerHTML = `
            <div class="observation-date">${date.toLocaleString('es-CL')}</div>
            <div class="observation-text">${obs.texto}</div>
          `;
          obsContainer.appendChild(div);
        });
      }
      
      document.querySelectorAll('.tag[data-tag]').forEach(tag => {
        tag.onclick = function() {
          const tagText = this.getAttribute('data-tag');
          addTagToProspect(tagText);
        };
      });
      
      showModal('prospectDetailModal');
    }

    function addTagToProspect(tag) {
      if (!currentProspectId) return;
      
      const prospects = getProspectsStorage();
      const index = prospects.findIndex(p => p.id === currentProspectId);
      
      if (index === -1) return;
      
      if (!prospects[index].etiquetas) {
        prospects[index].etiquetas = [];
      }
      
      if (!prospects[index].etiquetas.includes(tag)) {
        prospects[index].etiquetas.push(tag);
        setProspectsStorage(prospects);
        showProspectDetail(currentProspectId);
        showToast(`üè∑Ô∏è Etiqueta "${tag}" agregada`);
      }
    }

    function addObservation() {
      const textarea = document.getElementById('newObservation');
      const text = textarea.value.trim();
      
      if (!text) {
        alert('Por favor escribe una observaci√≥n.');
        return;
      }
      
      if (!currentProspectId) return;
      
      const prospects = getProspectsStorage();
      const index = prospects.findIndex(p => p.id === currentProspectId);
      
      if (index === -1) return;
      
      if (!prospects[index].observaciones) {
        prospects[index].observaciones = [];
      }
      
      prospects[index].observaciones.push({
        fecha: new Date().toISOString(),
        texto: text
      });
      
      prospects[index].fechaActualizacion = new Date().toISOString();
      
      setProspectsStorage(prospects);
      textarea.value = '';
      showProspectDetail(currentProspectId);
      showToast('‚úÖ Observaci√≥n agregada');
    }

    function saveProspectChanges() {
      if (!currentProspectId) return;
      
      const prospects = getProspectsStorage();
      const index = prospects.findIndex(p => p.id === currentProspectId);
      
      if (index === -1) return;
      
      prospects[index].estado = document.getElementById('detailProspectStatus').value;
      prospects[index].proximoContacto = document.getElementById('detailProspectNextContact').value;
      prospects[index].fechaActualizacion = new Date().toISOString();
      
      setProspectsStorage(prospects);
      hideModal('prospectDetailModal');
      loadProspects();
      updateProspectStats();
      showToast('‚úÖ Cambios guardados');
    }

    function confirmDeleteProspect() {
      if (!confirm('¬øEst√° seguro de eliminar este prospecto?')) {
        return;
      }
      
      deleteProspect();
    }

    function deleteProspect() {
      if (!currentProspectId) return;
      
      const prospects = getProspectsStorage();
      const index = prospects.findIndex(p => p.id === currentProspectId);
      
      if (index === -1) return;
      
      prospects.splice(index, 1);
      setProspectsStorage(prospects);
      hideModal('prospectDetailModal');
      loadProspects();
      updateProspectStats();
      showToast('üóëÔ∏è Prospecto eliminado');
    }

    function guardarNombreVendedor() {
      const nombreInput = document.getElementById('vendedorNombre');
      const nombre = nombreInput.value.trim();
      
      if (!nombre) {
        alert('Por favor ingresa tu nombre.');
        return;
      }
      
      localStorage.setItem('nombre_vendedor', nombre);
      actualizarNombreVendedor();
      nombreInput.value = '';
      showToast('‚úÖ Nombre guardado correctamente');
    }
    
    function obtenerNombreVendedor() {
      return localStorage.getItem('nombre_vendedor') || 'Vendedor';
    }
    
    function actualizarNombreVendedor() {
      const nombre = obtenerNombreVendedor();
      document.getElementById('nombreVendedorActual').textContent = nombre;
    }
    
    function openWhatsApp() {
      const phone = document.getElementById('detailProspectPhone').textContent;
      const prospectName = document.getElementById('detailProspectName').textContent;
      const product = document.getElementById('detailProspectProduct').textContent;
      const vendedorNombre = obtenerNombreVendedor();
      
      const cleanPhone = phone.replace(/\D/g, '');
      
      if (!cleanPhone || cleanPhone.length < 9) {
        alert('N√∫mero de tel√©fono inv√°lido');
        return;
      }
      
      const message = encodeURIComponent(`Hola ${prospectName}, soy ${vendedorNombre} de Neum√°ticos y Llantas del Pac√≠fico. Te contacto por tu inter√©s en ${product}. ¬øEn qu√© puedo ayudarte?`);
      
      const whatsappPhone = '+56' + cleanPhone;
      
      const whatsappUrl = `https://wa.me/${whatsappPhone}?text=${message}`;
      
      hideModal('prospectDetailModal');
      
      setTimeout(() => {
        window.location.href = whatsappUrl;
        
        setTimeout(() => {
          if (document.visibilityState === 'visible') {
            window.open(whatsappUrl, '_blank');
          }
        }, 500);
      }, 100);
    }

    function callProspect() {
      const phone = document.getElementById('detailProspectPhone').textContent;
      const cleanPhone = phone.replace(/\D/g, '');
      
      if (!cleanPhone || cleanPhone.length < 9) {
        alert('N√∫mero de tel√©fono inv√°lido');
        return;
      }
      
      hideModal('prospectDetailModal');
      
      const telUrl = `tel:${cleanPhone}`;
      
      setTimeout(() => {
        window.location.href = telUrl;
        
        setTimeout(() => {
          if (document.visibilityState === 'visible') {
            alert(`En un dispositivo m√≥vil, esto iniciar√≠a una llamada a: ${cleanPhone}`);
          }
        }, 500);
      }, 100);
    }

    // ============================================
    // FUNCIONES DE MODALES GENERALES
    // ============================================

    function showModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function hideModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showCloseDayModal() {
      showModal('closeDayModal');
    }

    function showResetModal() {
      showModal('resetModal');
    }

    function showExportModal() {
      showModal('exportModal');
      updateExportOptions();
    }

    function showModifyModal() {
      showModal('modifyModal');
      document.getElementById('saleDate').value = getCurrentDate();
      document.getElementById('saleAmount').value = '';
      document.getElementById('searchQuery').value = '';
      updateModifyAction();
    }

    function confirmCloseDay() {
      closeDay();
      hideModal('closeDayModal');
    }

    function confirmReset() {
      if (!confirm('‚ö†Ô∏è ¬øEst√°s COMPLETAMENTE SEGURO? Se borrar√°n TODOS los datos de forma PERMANENTE.')) {
        return;
      }
      setStorage('ventas_dia', []);
      setStorage('ventas_ciclo', []);
      setStorage('ventas_permanentes', []);
      setStorage('prospectos', []);
      localStorage.removeItem('ultimo_cierre_ciclo');
      localStorage.removeItem('nombre_vendedor');
      setStorage('historial_ciclos', []);
      refreshUI();
      showToast('Sistema reseteado');
    }

    // ============================================
    // FUNCIONES DE EXPORTACI√ìN
    // ============================================

    function updateExportOptions() {
      const exportType = document.getElementById('exportType').value;
      const dateSelector = document.getElementById('dateSelector');
      const dateSelect = document.getElementById('dateSelect');
      
      dateSelect.innerHTML = '';
      
      if (exportType === 'day') {
        dateSelector.style.display = 'block';
        const salesDay = getStorage('ventas_dia');
        const today = getCurrentDate();
        
        if (salesDay.length > 0) {
          const option = document.createElement('option');
          option.value = today;
          option.textContent = `${today} (D√≠a actual - ${salesDay.length} ventas)`;
          dateSelect.appendChild(option);
        } else {
          const option = document.createElement('option');
          option.textContent = 'No hay ventas hoy';
          dateSelect.appendChild(option);
        }
      } else if (exportType === 'cycle') {
        dateSelector.style.display = 'block';
        const cycleSales = getCurrentCycleSales();
        const currentCycle = getCurrentCycle();
        
        if (cycleSales.length > 0) {
          const option = document.createElement('option');
          option.value = currentCycle;
          option.textContent = `${currentCycle} (Ciclo actual - ${cycleSales.length} ventas)`; 
          dateSelect.appendChild(option);
        } else {
          const option = document.createElement('option');
          option.textContent = 'No hay ventas en el ciclo actual';
          dateSelect.appendChild(option);
        }
      } else if (exportType === 'permanent') {
        dateSelector.style.display = 'block';
        const permanentSales = getStorage('ventas_permanentes');
        
        const uniqueMonths = [...new Set(permanentSales.map(s => s.month_id).filter(Boolean))].sort().reverse();
        
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'Todos los meses';
        dateSelect.appendChild(allOption);
        
        uniqueMonths.forEach(month => {
          const monthSales = permanentSales.filter(s => s.month_id === month);
          const option = document.createElement('option');
          option.value = month;
          option.textContent = `${month} (${monthSales.length} ventas)`;
          dateSelect.appendChild(option);
        });
        
        if (dateSelect.options.length === 1) {
          const option = document.createElement('option');
          option.textContent = 'No hay ventas en historial permanente';
          dateSelect.appendChild(option);
        }
      } else if (exportType === 'cycleHistory') {
        dateSelector.style.display = 'block';
        const cycleHistory = getStorage('historial_ciclos') || [];
        
        if (cycleHistory.length > 0) {
          cycleHistory.forEach((ciclo, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Ciclo ${ciclo.ciclo} - ${ciclo.fecha_cierre} - ${formatCLP(ciclo.comision_total)}`;
            dateSelect.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.textContent = 'No hay historial de cierres';
          dateSelect.appendChild(option);
        }
      } else {
        dateSelector.style.display = 'none';
      }
    }

    function confirmExport() {
      const exportType = document.getElementById('exportType').value;
      const dateSelect = document.getElementById('dateSelect');
      const selectedDate = dateSelect.value;
      
      let data = [];
      let filename = '';
      
      if (exportType === 'day') {
        const salesDay = getStorage('ventas_dia');
        const today = getCurrentDate();
        
        if (selectedDate === today) {
          data = salesDay;
          filename = `ventas_dia_${selectedDate}.csv`;
        }
      } else if (exportType === 'cycle') {
        const currentCycle = getCurrentCycle();
        const cycleSales = getCurrentCycleSales();
        
        if (selectedDate === currentCycle) {
          data = cycleSales;
          filename = `ventas_ciclo_${selectedDate}.csv`;
        }
      } else if (exportType === 'permanent') {
        const permanentSales = getStorage('ventas_permanentes');
        
        if (selectedDate === 'all') {
          data = permanentSales;
          filename = 'historial_permanente_completo.csv';
        } else {
          data = permanentSales.filter(s => s.month_id === selectedDate);
          filename = `historial_permanente_${selectedDate}.csv`;
        }
      } else if (exportType === 'cycleHistory') {
        const cycleHistory = getStorage('historial_ciclos') || [];
        if (selectedDate >= 0 && selectedDate < cycleHistory.length) {
          const ciclo = cycleHistory[selectedDate];
          data = [ciclo];
          filename = `cierre_ciclo_${ciclo.ciclo}_${ciclo.fecha_cierre}.csv`;
        }
      }
      
      if (data.length === 0) {
        alert('No hay datos para exportar en la selecci√≥n elegida');
        return;
      }
      
      let csv = '';
      if (exportType === 'cycleHistory') {
        csv = 'Fecha Cierre,Ciclo,Cantidad Ventas,Total con IVA,Total sin IVA,Comisi√≥n Total\n';
        data.forEach(c => {
          csv += `${c.fecha_cierre},${c.ciclo},${c.ventas_count},${c.total_with_vat},${c.total_without_vat},${c.comision_total}\n`;
        });
      } else {
        csv = 'Fecha/Hora,Monto con IVA,Neto sin IVA,Comisi√≥n,Fecha,Mes,Ciclo\n';
        data.forEach(s => {
          const timestamp = formatDateTimeForExcel(s.timestamp);
          const dateFormatted = formatDateForExcel(s.date_iso || s.timestamp);
          csv += `"${timestamp}",${s.amount_with_vat},${s.net_without_vat},${s.commission},"${dateFormatted}","${s.month_id}","${s.cycle_id || getCurrentCycle()}"\n`;
        });
      }
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      
      hideModal('exportModal');
      showToast(`‚úì Exportado: ${filename}`);
    }

    // ============================================
    // FUNCIONES DE MODIFICACI√ìN
    // ============================================

    function updateModifyAction() {
      const action = document.getElementById('modifyAction').value;
      const addSection = document.getElementById('addSaleSection');
      const deleteSection = document.getElementById('deleteSaleSection');
      const searchSection = document.getElementById('searchSaleSection');
      
      if (action === 'add') {
        addSection.style.display = 'block';
        deleteSection.style.display = 'none';
        searchSection.style.display = 'none';
      } else if (action === 'delete') {
        addSection.style.display = 'none';
        deleteSection.style.display = 'block';
        searchSection.style.display = 'none';
        updateDeleteList();
      } else if (action === 'search') {
        addSection.style.display = 'none';
        deleteSection.style.display = 'none';
        searchSection.style.display = 'block';
        searchPermanentSales();
      }
    }

    function updateDeleteList() {
      const period = document.getElementById('deletePeriod').value;
      const container = document.getElementById('salesListToDelete');
      container.innerHTML = '';
      
      let sales = [];
      if (period === 'day') {
        sales = getStorage('ventas_dia');
      } else if (period === 'cycle') {
        sales = getCurrentCycleSales();
      } else if (period === 'permanent') {
        sales = getStorage('ventas_permanentes');
      }
      
      if (sales.length === 0) {
        container.innerHTML = '<div style="padding: 12px; color: var(--muted); text-align: center;">No hay ventas para eliminar</div>';
        return;
      }
      
      sales.forEach((sale, index) => {
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 12px;
          margin: 4px 0;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s;
        `;
        
        const time = formatDateTimeForExcel(sale.timestamp);
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--accent);">${formatCLP(sale.amount_with_vat)}</div>
              <div style="font-size: 12px; color: var(--muted);">${time} | Com: ${formatCLP(sale.commission)}</div>
            </div>
            <button onclick="deleteSaleFromPeriod('${period}', ${index})" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Eliminar</button>
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function searchPermanentSales() {
      const query = document.getElementById('searchQuery').value.toLowerCase();
      const container = document.getElementById('searchResults');
      container.innerHTML = '';
      
      const permanentSales = getStorage('ventas_permanentes');
      
      if (permanentSales.length === 0) {
        container.innerHTML = '<div style="padding: 12px; color: var(--muted); text-align: center;">No hay ventas en el historial permanente</div>';
        return;
      }
      
      let filteredSales = permanentSales;
      
      if (query) {
        filteredSales = permanentSales.filter(sale => {
          const monthId = sale.month_id || '';
          const amount = sale.amount_with_vat.toString();
          const date = sale.date_iso || '';
          const cycle = sale.cycle_id || '';
          return monthId.toLowerCase().includes(query) || 
                 amount.includes(query) ||
                 date.toLowerCase().includes(query) ||
                 cycle.toLowerCase().includes(query);
        });
      }
      
      if (filteredSales.length === 0) {
        container.innerHTML = '<div style="padding: 12px; color: var(--muted); text-align: center;">No se encontraron ventas</div>';
        return;
      }
      
      filteredSales.slice(0, 50).forEach((sale, index) => {
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 12px;
          margin: 4px 0;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 8px;
        `;
        
        const time = formatDateTimeForExcel(sale.timestamp);
        
        div.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--accent);">${formatCLP(sale.amount_with_vat)}</div>
            <div style="font-size: 12px; color: var(--muted);">${time} | Com: ${formatCLP(sale.commission)}</div>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">Fecha: ${sale.date_iso} | Mes: ${sale.month_id} | Ciclo: ${sale.cycle_id || getCurrentCycle()}</div>
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function deleteSaleFromPeriod(period, index) {
      if (!confirm('¬øEst√°s seguro de eliminar esta venta? Esta acci√≥n no se puede deshacer.')) {
        return;
      }
      
      let saleToDelete;
      
      if (period === 'day') {
        const salesDay = getStorage('ventas_dia');
        saleToDelete = salesDay[index];
        
        const permanentSales = getStorage('ventas_permanentes');
        const permIndex = permanentSales.findIndex(s => 
          s.timestamp === saleToDelete.timestamp && 
          s.amount_with_vat === saleToDelete.amount_with_vat
        );
        if (permIndex !== -1) {
          permanentSales.splice(permIndex, 1);
          setStorage('ventas_permanentes', permanentSales);
        }
        
        salesDay.splice(index, 1);
        setStorage('ventas_dia', salesDay);
        
      } else if (period === 'cycle') {
        const cycleSales = getCurrentCycleSales();
        saleToDelete = cycleSales[index];
        
        const permanentSales = getStorage('ventas_permanentes');
        const permIndex = permanentSales.findIndex(s => 
          s.timestamp === saleToDelete.timestamp && 
          s.amount_with_vat === saleToDelete.amount_with_vat
        );
        if (permIndex !== -1) {
          permanentSales.splice(permIndex, 1);
          setStorage('ventas_permanentes', permanentSales);
        }
        
      } else if (period === 'permanent') {
        const permanentSales = getStorage('ventas_permanentes');
        saleToDelete = permanentSales[index];
        
        permanentSales.splice(index, 1);
        setStorage('ventas_permanentes', permanentSales);
        
        const today = getCurrentDate();
        if (saleToDelete.date_iso === today) {
          const salesDay = getStorage('ventas_dia');
          const dayIndex = salesDay.findIndex(s => 
            s.timestamp === saleToDelete.timestamp && 
            s.amount_with_vat === saleToDelete.amount_with_vat
          );
          if (dayIndex !== -1) {
            salesDay.splice(dayIndex, 1);
            setStorage('ventas_dia', salesDay);
          }
        }
      }
      
      refreshUI();
      updateDeleteList();
      showToast('‚úì Venta eliminada');
    }

    function confirmModify() {
      const action = document.getElementById('modifyAction').value;
      
      if (action === 'add') {
        const dateInput = document.getElementById('saleDate').value;
        const amountInput = document.getElementById('saleAmount').value;
        
        if (!dateInput) {
          alert('Por favor selecciona una fecha');
          return;
        }
        
        if (!amountInput) {
          alert('Por favor ingresa un monto');
          return;
        }
        
        try {
          const amt = parseAmount(amountInput);
          const net = Math.round(amt / 1.19);
          const commission = Math.round(net * COMMISSION_RATE);
          
          const now = new Date();
          const selectedDateTime = new Date(dateInput + 'T' + 
            String(now.getHours()).padStart(2, '0') + ':' + 
            String(now.getMinutes()).padStart(2, '0') + ':' + 
            String(now.getSeconds()).padStart(2, '0'));
          
          const sale = {
            amount_with_vat: Math.round(amt),
            net_without_vat: net,
            commission: commission,
            timestamp: selectedDateTime.toISOString(),
            date_iso: dateInput,
            month_id: dateInput.substring(0, 7),
            cycle_id: getCycleFromDate(dateInput) // Usa l√≥gica corregida
          };
          
          const permanentSales = getStorage('ventas_permanentes');
          permanentSales.push(sale);
          setStorage('ventas_permanentes', permanentSales);
          
          const currentCycle = getCurrentCycle();
          if (getCycleFromDate(dateInput) === currentCycle) {
            const cycleSales = getCurrentCycleSales();
            // No necesitamos guardar en ventas_ciclo porque se calcula din√°micamente
          }
          
          const today = getCurrentDate();
          if (dateInput === today) {
            const salesDay = getStorage('ventas_dia');
            salesDay.push(sale);
            setStorage('ventas_dia', salesDay);
          }
          
          hideModal('modifyModal');
          refreshUI();
          showToast(`‚úì Venta agregada con fecha ${formatDateForExcel(dateInput)}`);
        } catch (e) {
          alert(e.message);
        }
      }
    }

    // ============================================
    // FUNCIONES DE IMPORTACI√ìN CLIENTES
    // ============================================

    function showImportClientModal() {
      showModal('importClientModal');
      resetClientImportForm();
    }

    function resetClientImportForm() {
      document.getElementById('clientFile').value = '';
      document.getElementById('clientFileName').textContent = 'No se ha seleccionado ning√∫n archivo';
      document.getElementById('clientFilePreview').style.display = 'none';
      document.getElementById('clientUploadStats').style.display = 'none';
      document.getElementById('processClientBtn').disabled = true;
      clientFileData = [];
      clientFileHeaders = [];
    }

    function handleClientFileSelect(event) {
      const file = event.target.files[0];
      if (!file) {
        resetClientImportForm();
        return;
      }
      
      clientFileData = [];
      document.getElementById('clientFileName').textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
      
      const reader = new FileReader();
      
      if (file.name.endsWith('.csv')) {
        reader.onload = function(e) {
          try {
            parseCSVData(e.target.result);
          } catch (error) {
            alert('Error al leer el archivo CSV: ' + error.message);
            resetClientImportForm();
          }
        };
        reader.readAsText(file, 'UTF-8');
      } else {
        alert('Formato de archivo no soportado. Use CSV.');
        resetClientImportForm();
        return;
      }
    }

    function parseCSVData(content) {
      const lines = content.split('\n').filter(line => line.trim() !== '');
      
      if (lines.length === 0) {
        alert('El archivo CSV est√° vac√≠o.');
        resetClientImportForm();
        return;
      }
      
      const headers = lines[0].split(',').map(h => h.trim());
      clientFileHeaders = headers;
      
      const requiredHeaders = ['NombreApellido', 'Telefono', 'Producto', 'Estado'];
      const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
      
      if (missingHeaders.length > 0) {
        alert(`Faltan los siguientes encabezados obligatorios: ${missingHeaders.join(', ')}`);
        resetClientImportForm();
        return;
      }
      
      const data = [];
      let validRows = 0;
      let ignoredRows = 0;
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const cells = line.split(',').map(c => c.trim());
        const row = {};
        
        headers.forEach((header, index) => {
          row[header] = cells[index] || '';
        });
        
        if (!row.NombreApellido || !row.Telefono || !row.Producto || !row.Estado) {
          ignoredRows++;
          continue;
        }
        
        const validStatuses = ['Falta contactar', 'Contactado por WhatsApp', 'Contactado por llamada', 'Contactado por WhatsApp y Llamada'];
        if (!validStatuses.includes(row.Estado)) {
          ignoredRows++;
          continue;
        }
        
        data.push(row);
        validRows++;
      }
      
      clientFileData = data;
      
      showClientPreview(data.slice(0, 10));
      
      const existingProspects = getProspectsStorage();
      const duplicateRows = data.filter(row => 
        existingProspects.some(p => p.telefono === row.Telefono)
      ).length;
      
      showClientUploadStats(data.length, validRows, duplicateRows, ignoredRows);
      document.getElementById('processClientBtn').disabled = false;
    }

    function showClientPreview(data) {
      const previewBody = document.getElementById('clientPreviewBody');
      previewBody.innerHTML = '';
      
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.NombreApellido || ''}</td>
          <td>${row.Telefono || ''}</td>
          <td>${row.Producto || ''}</td>
          <td>${row.Estado || ''}</td>
          <td>${row.ObservacionInicial || ''}</td>
          <td>${row.ProximoContacto || ''}</td>
          <td>${row.Etiqueta || ''}</td>
        `;
        previewBody.appendChild(tr);
      });
      
      document.getElementById('clientFilePreview').style.display = 'block';
    }

    function showClientUploadStats(total, valid, duplicate, ignored) {
      document.getElementById('clientTotalRecords').textContent = total;
      document.getElementById('clientValidRecords').textContent = valid;
      document.getElementById('clientDuplicateRecords').textContent = duplicate;
      document.getElementById('clientIgnoredRecords').textContent = ignored;
      
      document.getElementById('clientUploadStats').style.display = 'block';
    }

    function processClientFile() {
      if (clientFileData.length === 0) {
        alert('No hay datos para procesar.');
        return;
      }
      
      const prospects = getProspectsStorage();
      let imported = 0;
      let duplicates = 0;
      let ignored = 0;
      
      clientFileData.forEach(row => {
        const existingProspect = prospects.find(p => p.telefono === row.Telefono);
        if (existingProspect) {
          duplicates++;
          return;
        }
        
        if (!row.NombreApellido || !row.Telefono || !row.Producto || !row.Estado) {
          ignored++;
          return;
        }
        
        const newProspect = {
          id: generateProspectId(),
          nombre: row.NombreApellido,
          telefono: row.Telefono,
          producto: row.Producto,
          estado: row.Estado,
          etiquetas: row.Etiqueta ? [row.Etiqueta] : [],
          proximoContacto: row.ProximoContacto || '',
          observaciones: [],
          fechaCreacion: new Date().toISOString(),
          fechaActualizacion: new Date().toISOString()
        };
        
        if (row.ObservacionInicial) {
          newProspect.observaciones.push({
            fecha: new Date().toISOString(),
            texto: row.ObservacionInicial
          });
        }
        
        prospects.push(newProspect);
        imported++;
      });
      
      setProspectsStorage(prospects);
      
      let message = `‚úÖ Importaci√≥n completada:\n\n`;
      message += `‚Ä¢ Registros en archivo: ${clientFileData.length}\n`;
      message += `‚Ä¢ Nuevos prospectos: ${imported}\n`;
      message += `‚Ä¢ Duplicados omitidos: ${duplicates}\n`;
      message += `‚Ä¢ Registros ignorados: ${ignored}`;
      
      alert(message);
      hideModal('importClientModal');
      loadProspects();
      updateProspectStats();
      showToast(`üì• ${imported} prospectos importados`);
    }

    function exportProspects() {
      const prospects = getProspectsStorage();
      
      if (prospects.length === 0) {
        alert('No hay prospectos para exportar.');
        return;
      }
      
      let csv = 'NombreApellido,Telefono,Producto,Estado,Etiquetas,ProximoContacto,Observaciones,FechaCreacion\n';
      
      prospects.forEach(p => {
        const etiquetas = p.etiquetas ? p.etiquetas.join(';') : '';
        const observaciones = p.observaciones ? p.observaciones.map(o => 
          `[${new Date(o.fecha).toLocaleString('es-CL')}] ${o.texto}`
        ).join(' | ') : '';
        
        csv += `"${p.nombre}","${p.telefono}","${p.producto}","${p.estado}","${etiquetas}","${p.proximoContacto || ''}","${observaciones}","${new Date(p.fechaCreacion).toLocaleString('es-CL')}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `prospectos_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showToast(`üì§ ${prospects.length} prospectos exportados`);
    }

    // ============================================
    // FUNCIONES DE PWA Y UTILIDADES
    // ============================================

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installPrompt').classList.add('show');
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            document.getElementById('installPrompt').classList.remove('show');
          }
          deferredPrompt = null;
        });
      }
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(createServiceWorkerBlob()).then(() => {
        console.log('Service Worker registrado');
      }).catch((err) => {
        console.warn('No se pudo registrar Service Worker:', err);
      });
    }

    function createServiceWorkerBlob() {
      const swCode = `
        const CACHE_NAME = 'comisiones-v1';
        self.addEventListener('install', (e) => {
          e.waitUntil(
            caches.open(CACHE_NAME).then((cache) => {
              return cache.addAll(['/']);
            })
          );
        });
        self.addEventListener('fetch', (e) => {
          e.respondWith(
            caches.match(e.request).then((response) => {
              return response || fetch(e.request);
            })
          );
        });
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      return URL.createObjectURL(blob);
    }

    const manifest = {
      name: "Sistema de Comisiones",
      short_name: "Comisiones",
      description: "Sistema de comisiones offline para vendedores",
      start_url: location.href,
      display: "standalone",
      background_color: "#0f0f10",
      theme_color: "#f7c600",
      orientation: "portrait",
      icons: [
        {
          src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%23f7c600' width='512' height='512'/%3E%3Ctext x='256' y='360' font-size='280' text-anchor='middle' fill='%23111111' font-weight='bold'%3Eüí∞%3C/text%3E%3C/svg%3E",
          sizes: "512x512",
          type: "image/svg+xml"
        }
      ]
    };

    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

    function showToast(message) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    // ============================================
    // INICIALIZACI√ìN
    // ============================================

    // Esta funci√≥n se llama desde el sistema de activaci√≥n
    function initializeMainApp() {
      // Inicializar sistema de navegaci√≥n
      initializeNavigation();
      
      const saleDateInput = document.getElementById('saleDate');
      if (saleDateInput) {
        saleDateInput.value = getCurrentDate();
        saleDateInput.type = 'date';
      }
      
      const searchQueryInput = document.getElementById('searchQuery');
      if (searchQueryInput) {
        searchQueryInput.addEventListener('input', searchPermanentSales);
      }
      
      const exportTypeSelect = document.getElementById('exportType');
      if (exportTypeSelect) {
        exportTypeSelect.addEventListener('change', updateExportOptions);
      }
      
      const saleAmountInput = document.getElementById('saleAmount');
      if (saleAmountInput) {
        saleAmountInput.addEventListener('input', (e) => {
          let value = e.target.value.replace(/[^0-9]/g, '');
          if (value) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;
            const num = parseInt(value);
            const formatted = '$ ' + num.toLocaleString('es-CL');
            e.target.value = formatted;
            const newLength = formatted.length;
            const diff = newLength - oldLength;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
          }
        });
      }
      
      const searchProspectInput = document.getElementById('searchProspect');
      if (searchProspectInput) {
        searchProspectInput.addEventListener('input', filterProspects);
      }
      
      actualizarNombreVendedor();
      
      // Configurar evento de tecla Escape para simular bot√≥n atr√°s
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' || e.key === 'Backspace') {
          e.preventDefault();
          handleBackButton();
        }
      });
      
      refreshUI();
      updateProspectStats();
    }

    const amountInputElement = document.getElementById('amountInput');
    if (amountInputElement) {
      amountInputElement.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addSale();
      });

      amountInputElement.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value) {
          const cursorPos = e.target.selectionStart;
          const oldLength = e.target.value.length;
          
          const num = parseInt(value);
          const formatted = '$ ' + num.toLocaleString('es-CL');
          e.target.value = formatted;
          
          const newLength = formatted.length;
          const diff = newLength - oldLength;
          e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
        }
      });
    }

    // Exponer funciones al scope global
    (function exposeApiToWindow() {
      const apiNames = [
        'showMainScreen','showAnalysisScreen','showCRMScreen','showUploadModal','showModifyModal','showCloseDayModal','showCloseCycleModal',
        'showResetModal','showExportModal','addSale','deleteLastSale','saveProspect','showAddProspectModal','showImportClientModal',
        'processClientFile','exportProspects','guardarNombreVendedor','openWhatsApp','callProspect','confirmCloseDay','confirmCloseCycle',
        'confirmReset','confirmExport','confirmModify','saveProspectChanges','confirmDeleteProspect','showProspectDetail','filterProspects',
        'resetFilters','handleFileSelect','handleClientFileSelect','processCSVFile','processClientFile','hideModal','showModal',
        'showUninstallModal','checkUninstallConfirmation','performCompleteUninstall','handleBackButton','goBackInApp'
      ];
      apiNames.forEach(name => {
        try {
          if (typeof window[name] === 'function') return;
          const fn = (typeof eval(name) === 'function') ? eval(name) : undefined;
          if (typeof fn === 'function') window[name] = fn;
        } catch (e) {}
      });
    })();

    window.addEventListener('error', (evt) => {
      console.error('Unhandled JS error:', evt.message, 'at', evt.filename + ':' + evt.lineno);
    });
  </script>
</body>
</html>
