<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f7c600">
  <meta name="description" content="Sistema de comisiones offline para vendedores">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Comisiones">
  <title>Sistema de Comisiones</title>
  <link rel="manifest" href="#" id="manifest-placeholder">
  <style>
    :root {
      --bg: #0f0f10;
      --card: #1a1a1c;
      --text: #ffffff;
      --accent: #f7c600;
      --accent-strong: #d1a400;
      --muted: #999999;
      --border: #2a2a2a;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 8px;
      overflow-x: hidden;
    }
    
    .header {
      background: var(--accent);
      padding: 16px 12px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(247, 198, 0, 0.3);
    }
    
    .header h2 {
      margin: 0;
      color: #111111;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
    }
    
    .header p {
      margin: 4px 0 0 0;
      color: #111111;
      font-size: 13px;
      opacity: 0.85;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    
    .totals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .total-cell {
      background: var(--card);
      border-radius: 8px;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .total-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .total-value {
      font-size: 18px;
      color: var(--accent);
      font-weight: 700;
      word-break: break-word;
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      flex: 1;
      background: var(--card);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      padding: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input[type="text"]:focus {
      border-color: var(--accent);
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: scale(0.97);
    }
    
    .btn-accent {
      background: var(--accent);
      color: #111111;
    }
    
    .btn-accent:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .btn-danger {
      background: #dc2626;
      color: #ffffff;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-info {
      background: #3b82f6;
      color: #ffffff;
    }
    
    .btn-info:hover {
      background: #2563eb;
    }
    
    .btn-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    
    .btn-container .btn {
      flex: 1;
      min-width: 140px;
    }
    
    .sales-list {
      background: var(--card);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
    }
    
    .sales-list:empty::after {
      content: "(sin ventas)";
      color: var(--muted);
      font-style: italic;
      display: block;
      text-align: center;
      padding: 20px;
    }
    
    .sale-item {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      line-height: 1.6;
      min-height: 40px;
    }
    
    .sale-item:last-child {
      border-bottom: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      border: 2px solid var(--border);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
    }
    
    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    
    .modal-buttons .btn {
      flex: 1;
    }
    
    .install-prompt {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .install-prompt.show {
      display: flex;
    }
    
    .install-prompt-text {
      flex: 1;
      color: #111111;
      font-size: 14px;
      font-weight: 600;
    }
    
    .install-prompt .btn {
      background: #111111;
      color: var(--accent);
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .analysis-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .analysis-screen.active {
      display: block;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .kpi-card {
      background: var(--card);
      border-radius: 8px;
      padding: 16px 12px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .kpi-period {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .kpi-title {
      font-size: 13px;
      color: var(--accent);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .kpi-value {
      font-size: 18px;
      color: var(--text);
      font-weight: 700;
      word-break: break-word;
    }
    
    .hourly-chart-container {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    .file-upload-container {
      margin: 16px 0;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-button {
      background: var(--accent);
      color: #111111;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: block;
      text-align: center;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .file-input-button:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .file-name {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      word-break: break-all;
    }
    
    .upload-preview {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
    }
    
    .upload-preview table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .upload-preview th {
      text-align: left;
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--accent);
      font-size: 11px;
    }
    
    .upload-preview td {
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    
    input[type="date"] {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      width: 100%;
      position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.7;
      cursor: pointer;
      padding: 4px;
      margin-left: 4px;
    }
    
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
    }
    
    .date-input-wrapper {
      position: relative;
      width: 100%;
    }
    
    .date-input-wrapper::after {
      content: "üìÖ";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      font-size: 16px;
      pointer-events: none;
    }
    
    select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px 36px 12px 12px;
      font-size: 14px;
      width: 100%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23f7c600' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 16px 0;
    }
    
    .actions-grid .btn {
      width: 100%;
    }
    
    .tag {
      display: inline-block;
      padding: 4px 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    
    .tag:hover {
      background: var(--accent);
      color: #111111;
      transform: scale(1.05);
    }
    
    .tag.active {
      background: var(--accent);
      color: #111111;
      font-weight: 600;
    }
    
    .prospect-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .prospect-item:hover {
      background: rgba(247, 198, 0, 0.1);
    }
    
    .prospect-info {
      flex: 1;
    }
    
    .prospect-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .prospect-details {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .prospect-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-not-contacted {
      background: #dc2626;
      color: white;
    }
    
    .status-contacted {
      background: #10b981;
      color: white;
    }
    
    .status-whatsapp {
      background: #25D366;
      color: white;
    }
    
    .status-call {
      background: #3b82f6;
      color: white;
    }
    
    .status-both {
      background: linear-gradient(135deg, #25D366 0%, #3b82f6 100%);
      color: white;
    }
    
    .observation-item {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    
    .observation-date {
      color: var(--accent);
      font-size: 10px;
      margin-bottom: 2px;
    }
    
    .observation-text {
      color: var(--text);
    }
    
    .btn-whatsapp {
      background: #25D366;
      color: white;
    }
    
    .btn-whatsapp:hover {
      background: #1da851;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }
    
    .vendedor-config {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    .vendedor-config h3 {
      font-size: 16px;
      color: var(--accent);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .vendedor-config h3::before {
      content: "üë§";
      font-size: 18px;
    }
    
    .vendedor-input-group {
      display: flex;
      gap: 8px;
    }
    
    .vendedor-input-group input {
      flex: 1;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
    }
    
    .vendedor-input-group button {
      background: var(--accent);
      color: #111111;
      border: none;
      border-radius: 8px;
      padding: 0 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vendedor-input-group button:hover {
      background: var(--accent-strong);
    }
    
    .vendedor-current {
      margin-top: 12px;
      padding: 10px;
      background: rgba(247, 198, 0, 0.1);
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    
    .vendedor-current strong {
      color: var(--accent);
    }
    
    .btn-flashing {
      background: #dc2626;
      color: #ffffff;
      position: relative;
      overflow: hidden;
      animation: flashing 0.7s infinite;
      box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
    }
    
    .btn-flashing:hover {
      background: #b91c1c;
      animation: flashing-fast 0.4s infinite;
    }
    
    @keyframes flashing {
      0% { 
        background-color: #dc2626;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
      }
      50% { 
        background-color: #ff0000;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      }
      100% { 
        background-color: #dc2626;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.7);
      }
    }
    
    @keyframes flashing-fast {
      0% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
      25% { 
        background-color: #ff0000;
        box-shadow: 0 0 25px rgba(255, 0, 0, 1);
      }
      50% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
      75% { 
        background-color: #ff0000;
        box-shadow: 0 0 25px rgba(255, 0, 0, 1);
      }
      100% { 
        background-color: #dc2626;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
      }
    }
    
    .btn-nuclear {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #7f1d1d 100%);
      color: white;
      border: 2px solid #f87171;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
    }
    
    .btn-nuclear:hover {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
      box-shadow: 0 0 30px rgba(220, 38, 38, 0.8);
      transform: scale(1.02);
    }
    
    .btn-nuclear:active {
      animation: nuclear-pulse 0.3s;
    }
    
    @keyframes nuclear-pulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
    
    @media (max-width: 768px) {
      .header h2 { font-size: 18px; }
      .total-value { font-size: 16px; }
      .total-label { font-size: 10px; }
      .btn-container { flex-direction: column; }
      .btn-container .btn { min-width: 100%; }
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-value { font-size: 16px; }
      .sales-list { height: 180px; }
      .actions-grid { grid-template-columns: 1fr; }
      .vendedor-input-group { flex-direction: column; }
      .vendedor-input-group button { width: 100%; padding: 12px; }
    }
    
    @media (max-width: 480px) {
      body { padding: 4px; }
      .header h2 { font-size: 16px; }
      .total-value { font-size: 14px; }
      .total-label { font-size: 9px; }
      .totals-grid { gap: 6px; }
      .modal-content {
        padding: 16px;
        max-width: 95%;
      }
      .kpi-value { font-size: 14px; }
      .sales-list { height: 160px; }
    }
  </style>
</head>
<body>
  <div id="mainScreen">
    <div id="installPrompt" class="install-prompt">
      <div class="install-prompt-text">
        üì± Instala esta app en tu celular para usarla offline
      </div>
      <button class="btn" onclick="installApp()">Instalar</button>
    </div>

    <div class="header">
      <h2>Neum√°ticos y Llantas del Pac√≠fico</h2>
      <p>Sistema de Comisiones</p>
    </div>

    <div class="section-title">üìä Resumen de Ventas</div>
    <div class="totals-grid">
      <div class="total-cell">
        <div class="total-label">Total D√≠a (con IVA)</div>
        <div class="total-value" id="dayWithVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total D√≠a (sin IVA)</div>
        <div class="total-value" id="dayWithoutVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Comisi√≥n D√≠a</div>
        <div class="total-value" id="dayCommission">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total Ciclo (con IVA)</div>
        <div class="total-value" id="cycleWithVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total Ciclo (sin IVA)</div>
        <div class="total-value" id="cycleWithoutVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Comisi√≥n Ciclo</div>
        <div class="total-value" id="cycleCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">‚ûï Agregar Venta</div>
    <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
      Introduce el <strong>monto TOTAL con IVA</strong> (ejemplo: 119000):
    </p>
    <div class="input-group">
      <input type="text" id="amountInput" placeholder="119000" inputmode="numeric">
      <button class="btn btn-accent" onclick="addSale()">Agregar</button>
    </div>
    
    <button class="btn btn-danger" onclick="deleteLastSale()" style="width: 100%; margin-top: 8px; margin-bottom: 24px;">
      üóëÔ∏è Eliminar √öltima Venta
    </button>

    <div class="section-title">‚öôÔ∏è Acciones</div>
    <div class="actions-grid">
      <button class="btn btn-danger" onclick="showCloseDayModal()">Cerrar D√≠a</button>
      <button class="btn btn-danger" onclick="showCloseCycleModal()">Cerrar Ciclo Comisiones</button>
      <button class="btn btn-accent" onclick="showAnalysisScreen()">An√°lisis de Ventas</button>
      <button class="btn btn-accent" onclick="showModifyModal()">Modificar Ventas</button>
      <button class="btn btn-info" onclick="showCRMScreen()">Gesti√≥n de Clientes</button>
      <button class="btn btn-secondary" onclick="showExportModal()">Exportar Ventas</button>
      <button class="btn btn-info" onclick="showUploadModal()">Subir Archivos Ventas</button>
    </div>

    <div class="section-title">üìÖ Ventas del D√≠a</div>
    <div class="sales-list" id="salesDay" style="height: 250px;"></div>

    <div class="section-title">üìÜ Ventas del Ciclo Actual</div>
    <div class="sales-list" id="salesCycle" style="height: 250px;"></div>

    <div class="section-title">üîÑ Resetear Sistema</div>
    <p style="color: #dc2626; font-size: 13px; margin-bottom: 12px;">
      ‚ö†Ô∏è <strong>PELIGRO:</strong> Esta acci√≥n eliminar√° TODOS los datos guardados.
    </p>
    <button class="btn btn-danger" onclick="showResetModal()">Resetear Todo</button>

    <!-- NUEVO BOT√ìN DE DESINSTALACI√ìN COMPLETA -->
    <div class="section-title" style="margin-top: 40px; border-top: 2px solid #dc2626; padding-top: 20px;">
      ‚ò¢Ô∏è DESINSTALACI√ìN COMPLETA
    </div>
    <p style="color: #dc2626; font-size: 13px; margin-bottom: 12px;">
      ‚ö†Ô∏è <strong>ADVERTENCIA NUCLEAR:</strong> Esto eliminar√° la aplicaci√≥n completamente del dispositivo.
      Se borrar√°n todos los datos, cache, y la app dejar√° de funcionar.
    </p>
    <button class="btn btn-nuclear" onclick="showUninstallModal()" style="width: 100%; margin-bottom: 40px; padding: 16px; font-size: 16px;">
      ‚ò¢Ô∏è DESINSTALAR APP COMPLETAMENTE DEL M√ìVIL
    </button>
  </div>

  <!-- MODAL DE DESINSTALACI√ìN -->
  <div id="uninstallModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">‚ò¢Ô∏è ¬øDESINSTALAR APP COMPLETAMENTE?</div>
      <div style="margin: 16px 0; padding: 16px; background: rgba(220, 38, 38, 0.1); border-radius: 8px; border: 2px solid #dc2626;">
        <p style="color: white; font-weight: 600; margin-bottom: 12px;">‚ö†Ô∏è ADVERTENCIA EXTREMA:</p>
        <ul style="color: #fca5a5; font-size: 13px; line-height: 1.6; padding-left: 20px;">
          <li>Se eliminar√°n TODOS los datos permanentemente</li>
          <li>Se borrar√° el cache de la aplicaci√≥n</li>
          <li>La app se remover√° del dispositivo</li>
          <li>No podr√°s acceder a los datos sin reinstalar</li>
          <li>Esta acci√≥n NO se puede deshacer</li>
        </ul>
      </div>
      <p style="color: var(--muted); margin-bottom: 16px; font-size: 13px;">
        Si est√°s seguro, escribe <strong>"DESINSTALAR"</strong> en el siguiente campo:
      </p>
      <input type="text" id="uninstallConfirm" placeholder="Escribe DESINSTALAR aqu√≠" 
             style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); 
                    border: 2px solid #dc2626; border-radius: 8px; margin-bottom: 16px;"
             oninput="checkUninstallConfirmation()">
      <div class="modal-buttons">
        <button class="btn btn-nuclear" id="confirmUninstallBtn" onclick="performCompleteUninstall()" disabled>
          ‚ò¢Ô∏è CONFIRMAR DESINSTALACI√ìN COMPLETA
        </button>
        <button class="btn btn-secondary" onclick="hideModal('uninstallModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Resto del c√≥digo HTML (analysisScreen, crmScreen, y todos los dem√°s modales) -->
  <!-- Manteniendo todo el resto del c√≥digo exactamente igual -->
  
  <script>
    const COMMISSION_RATE = 0.009;
    let deferredPrompt = null;
    let selectedFile = null;
    let csvData = [];
    let currentProspectId = null;
    let clientFileData = [];
    let clientFileHeaders = [];

    // ============================================
    // FUNCIONES CR√çTICAS CORREGIDAS - LOGICA DE CICLOS
    // ============================================

    /**
     * Obtiene el ciclo correcto para una fecha espec√≠fica
     * BASADO EN: fecha_venta <= fecha_cierre -> Ciclo 1
     *            fecha_venta > fecha_cierre -> Ciclo 2
     */
    function getCycleFromDate(dateString) {
      const date = new Date(dateString);
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      
      if (!lastClose) {
        return 'C1'; // Primer ciclo (no hay cierres anteriores)
      }
      
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999); // Fin del d√≠a de cierre
      
      // CORRECCI√ìN: Si la fecha de venta es <= fecha_cierre, va en C1
      // Si es > fecha_cierre, va en C2
      if (date <= lastCloseDate) {
        return 'C1';
      } else {
        return 'C2';
      }
    }

    /**
     * Determina el ciclo actual basado en la fecha de hoy vs √∫ltimo cierre
     */
    function getCurrentCycle() {
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      if (!lastClose) return 'C1';
      
      const today = new Date();
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999);
      
      return today <= lastCloseDate ? 'C1' : 'C2';
    }

    /**
     * Obtiene TODAS las ventas del ciclo actual (posteriores al √∫ltimo cierre)
     * SIN LIMITE - TODAS LAS VENTAS
     */
    function getCurrentCycleSales() {
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      const permanentSales = getStorage('ventas_permanentes');
      
      if (!lastClose) {
        // Si no hay cierre previo, todas las ventas est√°n en C1
        return permanentSales;
      }
      
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999);
      
      // Solo ventas POSTERIORES al √∫ltimo cierre
      return permanentSales.filter(sale => {
        const saleDate = new Date(sale.date_iso);
        return saleDate > lastCloseDate;
      });
    }

    /**
     * Obtiene las ventas del ciclo anterior (hasta el √∫ltimo cierre inclusive)
     */
    function getPreviousCycleSales() {
      const lastClose = localStorage.getItem('ultimo_cierre_ciclo');
      const permanentSales = getStorage('ventas_permanentes');
      
      if (!lastClose) {
        return []; // No hay ciclo anterior
      }
      
      const lastCloseDate = new Date(lastClose);
      lastCloseDate.setHours(23, 59, 59, 999);
      
      // Ventas hasta el d√≠a de cierre inclusive
      return permanentSales.filter(sale => {
        const saleDate = new Date(sale.date_iso);
        return saleDate <= lastCloseDate;
      });
    }

    /**
     * Obtiene el resumen del √∫ltimo ciclo cerrado desde el historial
     */
    function getLastClosedCycleSummary() {
      const cycleHistory = getStorage('historial_ciclos') || [];
      
      if (cycleHistory.length === 0) {
        return null;
      }
      
      // Ordenar por fecha de cierre (m√°s reciente primero)
      const sortedHistory = cycleHistory.sort((a, b) => 
        new Date(b.fecha_cierre) - new Date(a.fecha_cierre)
      );
      
      // Devolver el √∫ltimo ciclo cerrado
      return sortedHistory[0];
    }

    // ============================================
    // FUNCIONES AUXILIARES GENERALES
    // ============================================

    function showMainScreen() {
      document.getElementById('mainScreen').style.display = 'block';
      document.getElementById('analysisScreen').classList.remove('active');
      document.getElementById('crmScreen').classList.remove('active');
      refreshUI();
    }

    function showAnalysisScreen() {
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('analysisScreen').classList.add('active');
      document.getElementById('crmScreen').classList.remove('active');
      calculateAndDisplayKPIs();
    }

    function showCRMScreen() {
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('analysisScreen').classList.remove('active');
      document.getElementById('crmScreen').classList.add('active');
      loadProspects();
      updateProspectStats();
      actualizarNombreVendedor();
    }

    function getStorage(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('Error reading storage:', e);
        return [];
      }
    }

    function setStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) {
        console.error('Error saving storage:', e);
        alert('Error al guardar datos. Verifica el espacio disponible.');
        return false;
      }
    }

    function formatCLP(amount) {
      const num = Math.round(parseFloat(amount) || 0);
      const sign = num < 0 ? '-' : '';
      const abs = Math.abs(num);
      return `${sign}$ ${abs.toLocaleString('es-CL')}`;
    }

    function getCurrentDate() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    function parseAmount(str) {
      if (!str) throw new Error('Introduce un n√∫mero v√°lido');
      const cleaned = str.replace(/[^0-9]/g, '');
      if (!cleaned) throw new Error('Introduce un n√∫mero v√°lido');
      return parseFloat(cleaned);
    }

    /**
     * Formato de fecha/hora legible: "DD/MM/YYYY HH:MM"
     */
    function formatDateTimeLegible(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function formatDateForExcel(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${day}/${month}/${year}`;
    }

    function formatDateTimeForExcel(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // ============================================
    // FUNCIONES DE VENTAS Y COMISIONES - RENDERIZACI√ìN MEJORADA
    // ============================================

    function addSale() {
      const input = document.getElementById('amountInput');
      const amountText = input.value;
      
      try {
        const amt = parseAmount(amountText);
        const net = Math.round(amt / 1.19);
        const commission = Math.round(net * COMMISSION_RATE);
        
        const sale = {
          amount_with_vat: Math.round(amt),
          net_without_vat: net,
          commission: commission,
          timestamp: new Date().toISOString(),
          date_iso: getCurrentDate(),
          month_id: getCurrentDate().substring(0, 7),
          cycle_id: getCycleFromDate(getCurrentDate())
        };

        // Agregar a ventas permanentes
        const permanentSales = getStorage('ventas_permanentes');
        permanentSales.push(sale);
        setStorage('ventas_permanentes', permanentSales);

        // Agregar a ciclo actual si corresponde
        if (getCurrentCycle() === sale.cycle_id) {
          const salesCycle = getStorage('ventas_ciclo');
          salesCycle.push(sale);
          setStorage('ventas_ciclo', salesCycle);
        }

        // Agregar a ventas del d√≠a
        const salesDay = getStorage('ventas_dia');
        salesDay.push(sale);
        setStorage('ventas_dia', salesDay);

        if (input.value) {
          input.value = '';
          refreshUI();
          showToast('‚úì Venta agregada correctamente');
        }
      } catch (e) {
        alert(e.message);
      }
    }

    function deleteLastSale() {
      const salesDay = getStorage('ventas_dia');
      
      if (salesDay.length === 0) {
        alert('No hay ventas para eliminar');
        return;
      }
      
      const lastSale = salesDay[salesDay.length - 1];
      const lastAmount = formatCLP(lastSale.amount_with_vat);
      
      if (!confirm(`¬øEliminar la √∫ltima venta de ${lastAmount}?`)) {
        return;
      }
      
      // Eliminar de ventas permanentes
      const permanentSales = getStorage('ventas_permanentes');
      const permIndex = permanentSales.findIndex(s => 
        s.timestamp === lastSale.timestamp && 
        s.amount_with_vat === lastSale.amount_with_vat
      );
      if (permIndex !== -1) {
        permanentSales.splice(permIndex, 1);
        setStorage('ventas_permanentes', permanentSales);
      }
      
      // Eliminar de ventas del d√≠a
      salesDay.pop();
      setStorage('ventas_dia', salesDay);
      
      // Eliminar de ciclo si corresponde
      const salesCycle = getStorage('ventas_ciclo');
      const cycleIndex = salesCycle.findIndex(s => 
        s.timestamp === lastSale.timestamp && 
        s.amount_with_vat === lastSale.amount_with_vat
      );
      if (cycleIndex !== -1) {
        salesCycle.splice(cycleIndex, 1);
        setStorage('ventas_ciclo', salesCycle);
      }
      
      refreshUI();
      showToast('‚úì √öltima venta eliminada');
    }

    /**
     * REFRESH UI MEJORADO - MUESTRA TODAS LAS VENTAS
     */
    function refreshUI() {
      const salesDay = getStorage('ventas_dia');
      const currentCycleSales = getCurrentCycleSales(); // TODAS las ventas del ciclo
      
      const dayWithVat = Math.round(salesDay.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const dayWithoutVat = Math.round(salesDay.reduce((sum, s) => sum + s.net_without_vat, 0));
      const dayCommission = Math.round(salesDay.reduce((sum, s) => sum + s.commission, 0));
      
      const cycleWithVat = Math.round(currentCycleSales.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const cycleWithoutVat = Math.round(currentCycleSales.reduce((sum, s) => sum + s.net_without_vat, 0));
      const cycleCommission = Math.round(currentCycleSales.reduce((sum, s) => sum + s.commission, 0));
      
      document.getElementById('dayWithVat').textContent = formatCLP(dayWithVat);
      document.getElementById('dayWithoutVat').textContent = formatCLP(dayWithoutVat);
      document.getElementById('dayCommission').textContent = formatCLP(dayCommission);
      document.getElementById('cycleWithVat').textContent = formatCLP(cycleWithVat);
      document.getElementById('cycleWithoutVat').textContent = formatCLP(cycleWithoutVat);
      document.getElementById('cycleCommission').textContent = formatCLP(cycleCommission);
      
      // RENDERIZACI√ìN MEJORADA - TODAS LAS VENTAS, NO SOLO 20
      renderSalesList('salesDay', salesDay.slice().reverse()); // Mostrar TODAS del d√≠a
      renderSalesList('salesCycle', currentCycleSales.slice().reverse()); // Mostrar TODAS del ciclo
      
      updateCycleSummary();
    }

    /**
     * RENDERIZACI√ìN MEJORADA - MUESTRA FECHA/HORA LEGIBLE
     */
    function renderSalesList(elementId, sales) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      
      if (sales.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted); font-style: italic;">(sin ventas)</div>';
        return;
      }
      
      sales.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'sale-item';
        
        // Formato legible: "DD/MM/YYYY HH:MM"
        const dateTime = formatDateTimeLegible(s.timestamp);
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--accent); margin-bottom: 2px;">
                ${formatCLP(s.amount_with_vat)}
              </div>
              <div style="font-size: 11px; color: var(--muted);">
                üìÖ ${dateTime}
              </div>
            </div>
            <div style="text-align: right; min-width: 100px;">
              <div style="font-size: 12px; color: var(--text);">
                Neto: ${formatCLP(s.net_without_vat)}
              </div>
              <div style="font-size: 12px; color: var(--accent); font-weight: 600;">
                Com: ${formatCLP(s.commission)}
              </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // ============================================
    // FUNCIONES DE IMPORTACI√ìN CSV SIN DETECCI√ìN DE DUPLICADOS
    // ============================================

    function processCSVFile() {
      if (!selectedFile || csvData.length === 0) {
        alert('No hay archivo para procesar.');
        return;
      }

      const permanentSales = getStorage('ventas_permanentes');
      const today = getCurrentDate();
      const currentCycle = getCurrentCycle();
      
      let addedToPermanent = 0;
      let addedToCycle = 0;
      let addedToDay = 0;

      csvData.forEach(row => {
        // SIN DETECCI√ìN DE DUPLICADOS - TODAS LAS VENTAS SE IMPORTAN
        const cycleId = getCycleFromDate(row.date_iso);
        
        const sale = {
          amount_with_vat: row.amount_with_vat,
          net_without_vat: row.net_without_vat,
          commission: row.commission,
          timestamp: row.timestamp,
          date_iso: row.date_iso,
          month_id: row.month_id,
          cycle_id: cycleId
        };

        permanentSales.push(sale);
        addedToPermanent++;

        // Agregar al ciclo actual si corresponde
        if (cycleId === currentCycle) {
          const salesCycle = getStorage('ventas_ciclo');
          salesCycle.push(sale);
          setStorage('ventas_ciclo', salesCycle);
          addedToCycle++;
        }

        // Agregar a ventas del d√≠a si corresponde
        if (row.date_iso === today) {
          const salesDay = getStorage('ventas_dia');
          salesDay.push(sale);
          setStorage('ventas_dia', salesDay);
          addedToDay++;
        }
      });

      setStorage('ventas_permanentes', permanentSales);

      let message = `‚úÖ Archivo procesado correctamente (sin verificaci√≥n de duplicados):\n\n`;
      message += `‚Ä¢ Registros importados: ${csvData.length}\n`;
      
      if (addedToCycle > 0) {
        message += `‚Ä¢ Agregados al ciclo actual: ${addedToCycle}\n`;
      }
      
      if (addedToDay > 0) {
        message += `‚Ä¢ Agregados al d√≠a actual: ${addedToDay}\n`;
      }

      alert(message);
      hideModal('uploadModal');
      refreshUI();
      showToast(`‚úÖ ${csvData.length} ventas importadas (sin verificar duplicados)`);
    }

    // ============================================
    // FUNCIONES DE DESINSTALACI√ìN COMPLETA
    // ============================================

    function showUninstallModal() {
      showModal('uninstallModal');
      document.getElementById('uninstallConfirm').value = '';
      document.getElementById('confirmUninstallBtn').disabled = true;
    }

    function checkUninstallConfirmation() {
      const input = document.getElementById('uninstallConfirm');
      const confirmBtn = document.getElementById('confirmUninstallBtn');
      confirmBtn.disabled = input.value.toUpperCase() !== 'DESINSTALAR';
    }

    function performCompleteUninstall() {
      // 1. Eliminar TODOS los datos de localStorage
      const keysToRemove = [
        'ventas_dia', 'ventas_ciclo', 'ventas_permanentes', 
        'prospectos', 'ultimo_cierre_ciclo', 'nombre_vendedor',
        'historial_ciclos'
      ];
      
      keysToRemove.forEach(key => {
        localStorage.removeItem(key);
      });
      
      // 2. Eliminar todos los datos de IndexedDB si existe
      if (window.indexedDB) {
        indexedDB.databases().then(databases => {
          databases.forEach(db => {
            indexedDB.deleteDatabase(db.name);
          });
        }).catch(console.log);
      }
      
      // 3. Eliminar cache de Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.unregister();
          });
        });
        
        // Eliminar cache
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
              caches.delete(cacheName);
            });
          });
        }
      }
      
      // 4. Mostrar mensaje final
      hideModal('uninstallModal');
      
      setTimeout(() => {
        alert('‚úÖ APP DESINSTALADA COMPLETAMENTE\n\n' +
              'Todos los datos han sido eliminados.\n' +
              'La aplicaci√≥n ya no funcionar√° en este dispositivo.\n' +
              'Para volver a usar el sistema, deber√°s reinstalarla manualmente.');
        
        // 5. Intentar eliminar la app instalada (si es PWA)
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
          // En algunos dispositivos se puede sugerir desinstalaci√≥n
          if (navigator.app && navigator.app.uninstallApp) {
            navigator.app.uninstallApp();
          } else {
            // Mostrar instrucciones para desinstalar manualmente
            alert('Para completar la desinstalaci√≥n:\n' +
                  '1. Ve a la configuraci√≥n de tu dispositivo\n' +
                  '2. Busca "Aplicaciones" o "Apps"\n' +
                  '3. Encuentra "Sistema de Comisiones"\n' +
                  '4. Selecciona "Desinstalar"\n\n' +
                  'Los datos ya han sido eliminados.');
          }
        }
        
        // 6. Recargar p√°gina para limpiar estado
        setTimeout(() => {
          window.location.href = 'about:blank';
          window.close();
        }, 2000);
      }, 500);
    }

    // ============================================
    // FUNCIONES RESTANTES (sin cambios)
    // ============================================

    // ... (Todas las dem√°s funciones permanecen exactamente igual)
    // closeDay(), showCloseCycleModal(), updateCycleSummary(), confirmCloseCycle()
    // calculateAndDisplayKPIs(), getStartOfWeek(), isDateInWeek()
    // getProspectsStorage(), setProspectsStorage(), generateProspectId()
    // showAddProspectModal(), saveProspect(), loadProspects(), updateProductFilter()
    // filterProspects(), resetFilters(), updateProspectStats(), showProspectDetail()
    // addTagToProspect(), addObservation(), saveProspectChanges(), confirmDeleteProspect()
    // deleteProspect(), guardarNombreVendedor(), obtenerNombreVendedor(), actualizarNombreVendedor()
    // openWhatsApp(), callProspect()
    // showModal(), hideModal(), showCloseDayModal(), showResetModal(), showExportModal()
    // showModifyModal(), confirmCloseDay(), confirmReset(), updateExportOptions()
    // confirmExport(), updateModifyAction(), updateDeleteList(), searchPermanentSales()
    // deleteSaleFromPeriod(), confirmModify()
    // showImportClientModal(), resetClientImportForm(), handleClientFileSelect()
    // parseCSVData(), showClientPreview(), showClientUploadStats(), processClientFile()
    // exportProspects()
    // installApp(), createServiceWorkerBlob(), createManifest(), showToast()

    // ============================================
    // INICIALIZACI√ìN
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      const saleDateInput = document.getElementById('saleDate');
      if (saleDateInput) {
        saleDateInput.value = getCurrentDate();
        saleDateInput.type = 'date';
      }
      
      const searchQueryInput = document.getElementById('searchQuery');
      if (searchQueryInput) {
        searchQueryInput.addEventListener('input', searchPermanentSales);
      }
      
      const exportTypeSelect = document.getElementById('exportType');
      if (exportTypeSelect) {
        exportTypeSelect.addEventListener('change', updateExportOptions);
      }
      
      const saleAmountInput = document.getElementById('saleAmount');
      if (saleAmountInput) {
        saleAmountInput.addEventListener('input', (e) => {
          let value = e.target.value.replace(/[^0-9]/g, '');
          if (value) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;
            const num = parseInt(value);
            const formatted = '$ ' + num.toLocaleString('es-CL');
            e.target.value = formatted;
            const newLength = formatted.length;
            const diff = newLength - oldLength;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
          }
        });
      }
      
      const searchProspectInput = document.getElementById('searchProspect');
      if (searchProspectInput) {
        searchProspectInput.addEventListener('input', filterProspects);
      }
      
      actualizarNombreVendedor();
      
      refreshUI();
      updateProspectStats();
    });

    const amountInputElement = document.getElementById('amountInput');
    if (amountInputElement) {
      amountInputElement.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addSale();
      });

      amountInputElement.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value) {
          const cursorPos = e.target.selectionStart;
          const oldLength = e.target.value.length;
          
          const num = parseInt(value);
          const formatted = '$ ' + num.toLocaleString('es-CL');
          e.target.value = formatted;
          
          const newLength = formatted.length;
          const diff = newLength - oldLength;
          e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
        }
      });
    }

    // ============================================
    // PWA MANIFEST
    // ============================================

    const manifest = {
      name: "Sistema de Comisiones",
      short_name: "Comisiones",
      description: "Sistema de comisiones offline para vendedores",
      start_url: location.href,
      display: "standalone",
      background_color: "#0f0f10",
      theme_color: "#f7c600",
      orientation: "portrait",
      icons: [
        {
          src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%23f7c600' width='512' height='512'/%3E%3Ctext x='256' y='360' font-size='280' text-anchor='middle' fill='%23111111' font-weight='bold'%3Eüí∞%3C/text%3E%3C/svg%3E",
          sizes: "512x512",
          type: "image/svg+xml"
        }
      ]
    };

    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

    function showToast(message) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    // Exponer funciones necesarias al scope global
    window.showUninstallModal = showUninstallModal;
    window.checkUninstallConfirmation = checkUninstallConfirmation;
    window.performCompleteUninstall = performCompleteUninstall;

    // ... (resto del c√≥digo de exposici√≥n de funciones)
  </script>
</body>
</html>
